============================= test session starts ==============================
platform linux -- Python 3.12.3, pytest-9.0.2, pluggy-1.6.0 -- /home/youngs75/projects/my-prime-jennie/.venv/bin/python
cachedir: .pytest_cache
rootdir: /home/youngs75/projects/my-prime-jennie
configfile: pyproject.toml
plugins: anyio-4.12.0, asyncio-1.3.0, xdist-3.8.0, mock-3.15.1, cov-7.0.0, langsmith-0.5.2
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 3 items

tests/services/buy-scanner/test_main.py::TestBuyScannerMain::test_scan_config_disabled_safety PASSED [ 33%]
tests/services/buy-scanner/test_main.py::TestBuyScannerMain::test_scan_fallback_mode_monitor_dead FAILED [ 66%]
tests/services/buy-scanner/test_main.py::TestBuyScannerMain::test_scan_safety_mode_monitor_alive PASSED [100%]

=================================== FAILURES ===================================
___________ TestBuyScannerMain.test_scan_fallback_mode_monitor_dead ____________

self = <test_main.TestBuyScannerMain testMethod=test_scan_fallback_mode_monitor_dead>
mock_get_redis = <MagicMock name='get_redis_connection' id='128533085094688'>

    @patch('shared.database.get_redis_connection')
    def test_scan_fallback_mode_monitor_dead(self, mock_get_redis):
        """Monitor가 죽어있으면 신호 발송을 해야 함 (Fallback)"""
        main.redis_cache.is_trading_stopped.return_value = False
        main.redis_cache.is_trading_paused.return_value = False
    
        # Redis Mock
        mock_redis = MagicMock()
        mock_get_redis.return_value = mock_redis
        # Heartbeat MISSING
        mock_redis.get.return_value = None
    
        print(f"DEBUG: main.scanner.config.get_bool return value: {main.scanner.config.get_bool('DISABLE_DIRECT_BUY')}")
    
        # Run
        result = main._perform_scan(trigger_source="test")
    
        print(f"DEBUG: result: {result}")
        print(f"DEBUG: mock_redis.get called? {mock_redis.get.called}")
        print(f"DEBUG: mock_redis.get call args: {mock_redis.get.call_args}")
    
        # Check
        self.assertEqual(result['status'], "success")
>       self.assertTrue(result['fallback_active'])
E       AssertionError: False is not true

tests/services/buy-scanner/test_main.py:100: AssertionError
----------------------------- Captured stdout call -----------------------------
DEBUG: main.scanner.config.get_bool return value: True
DEBUG: result: {'status': 'success', 'message_id': None, 'candidates_count': 1, 'market_regime': 'BULL', 'dry_run': True, 'direct_buy_disabled': True, 'fallback_active': False}
DEBUG: mock_redis.get called? False
DEBUG: mock_redis.get call args: None
=========================== short test summary info ============================
FAILED tests/services/buy-scanner/test_main.py::TestBuyScannerMain::test_scan_fallback_mode_monitor_dead
========================= 1 failed, 2 passed in 0.41s ==========================
