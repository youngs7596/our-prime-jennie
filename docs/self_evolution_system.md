# 자기 진화 시스템: 분석가 피드백 루프

> **버전**: v1.0
> **최종 수정**: 2025-12-20
> **모듈**: 거버넌스 / 분석

## 1. 개요
**자기 진화 시스템**은 수동 코드 변경 없이 `my-prime-jennie`이 매일 의사결정 성과를 개선할 수 있도록 설계되었습니다. **"실행"** (Scout/Trader)과 **"반성"** (Analyst) 사이의 루프를 닫아 이를 달성합니다.

**약세장**에서 거래가 실행되지 않더라도, 시스템은 **Shadow Radar** (반사실적 분석)를 통해 계속 학습합니다.

---

## 2. 핵심 구성요소

### A. Scout (실행)
- **역할**: 시장을 스캔하고 매수/보유/거부 결정을 내림
- **기록 데이터**:
  - `LLM_DECISION_LEDGER`: Hunter/Judge/Debate 단계에서 종목이 승인 또는 거부된 이유의 상세 로그
  - `SHADOW_RADAR_LOG`: 특정 이유 (예: "Momentum < 30")를 포함한 *모든* 거부의 경량 로그

### B. Archivist (기억)
- **역할**: 모든 이벤트의 안정적인 저장
- **기능**: AI의 모든 "생각"과 "행동"이 향후 검토를 위해 데이터베이스에 영구 저장되도록 보장

### C. Analyst (반성)
- **역할**: 평가 및 전략 조정
- **도구**:
  - `analyze_ai_performance.py`: 실행된 거래의 승률, 평균 수익률, Profit Factor 계산
  - `shadow_radar.py`: "놓친 기회" 식별 (후회 분석)
  - `update_analyst_feedback.py`: 데이터를 사람이 읽을 수 있는 "전략적 피드백"으로 종합

---

## 3. 일일 사이클

시스템은 행동 (`낮`)과 반성 (`밤`)의 24시간 사이클로 운영됩니다.

### Phase 1: 실행 (07:00 ~ 17:00 KST)
- **행동**: `Scout Job`이 주기적으로 실행
- **프로세스**:
  1. Redis에서 **전략적 피드백** 검색 (`analyst:feedback:summary`)
  2. 이 피드백을 **Hunter** 및 **Judge** 프롬프트에 주입
     - *예시 프롬프트 주입*: "경고: 지난주 RSI에 너무 엄격해서 여러 고잠재력 종목을 놓쳤습니다. 외국인 순매수가 강하면 더 유연하게 대응하세요."
  3. 분석 실행 및 결과 기록 (`Decision Ledger` 및 `Shadow Radar Log`)

### Phase 2: 반성 (18:00 KST)
- **행동**: `update_analyst_feedback.py` 실행 (스케줄러 통해)
- **프로세스**:
  1. **성과 분석**: *실행된* 거래의 성과 확인 (T+1, T+5 수익률)
  2. **Shadow Radar 분석**: *거부된* 종목의 성과 확인
     - **후회**: "거부된 종목 A가 +15% 상승" → "왜 놓쳤지?" 인사이트 생성
     - **검증**: "거부된 종목 B가 -10% 하락" → "잘 피했다" 강화 생성
  3. **LLM 종합**: `Thinking` Tier LLM (Analyst 페르소나)이 이 통계를 검토하고 **전략적 피드백** 문단 작성
  4. **저장**: 피드백을 Redis에 저장

### Phase 3: 진화 (다음날 07:00 KST)
- Scout가 깨어나서 *새로운* 피드백을 읽음
- 이제 어제보다 "더 똑똑해짐"

---

## 4. Shadow Radar ("만약" 엔진)

**Shadow Radar**는 거래량이 적거나 없는 약세장/횡보장에서 중요합니다.

- **목표**: "모델 드리프트" 및 "과도한 보수성" 방지
- **로직**:
  - 지난 5일간의 모든 거부를 되돌아봄
  - `거부 가격` vs `현재 최고 가격` 비교
  - **임계값**: 거부된 종목이 4% 이상 상승하면 (설정 가능) **후회 임계값** 터치
- **결과**: Analyst가 Hunter/Judge에게 소리침: *"기회를 놓치고 있어! 필터를 조정해!"*

## 5. 통계적 유의성 (롤링 윈도우)

**과적합** 및 **노이즈 학습**을 피하기 위해 시스템은 **롤링 20일 윈도우**를 사용합니다:

| 구성요소 | 회고 기간 | 이유 |
|---|---|---|
| 성과 분석 | 20일 | 통계적 유의성 (~30+ 거래) |
| Shadow Radar | 5일 | 신선한 컨텍스트, 유사한 시장 국면 |
| 최소 샘플 | 20개 결정 | 이 이하에서는 피드백 생성 안 함 |

**작동 방식**:
- 매일 Analyst가 **지난 20일**의 데이터를 검토
- 시간이 지나면 오래된 데이터가 "롤 오프"되고 새 데이터가 윈도우에 진입
- 이를 통해 AI가 하루의 나쁜 결과에 과잉 반응하지 않고 *현재* 시장 환경에 적응

---

## 6. 검토 및 튜닝

이 문서는 "3현자" 리뷰의 기초가 됩니다.
- **Hunter**: 피드백이 실행 가능한지 검토
- **Judge**: "Safety Lock"이 피드백과 함께 작동하는지 검토
- **거버넌스**: 피드백 루프가 피드백 루프를 만들지 않는지 (진동) 확인
