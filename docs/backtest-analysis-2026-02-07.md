# Scout Scoring System 백테스트 분석 & 개선 제안

> 2026-02-07 | Grid Backtest (216 조합) + LLM Score 상관분석 결과
> 분석 기간: Phase 1 (2025-12-01 ~ 2026-02-06), Phase 2 Watchlist (2026-01-11 ~ 2026-02-06)
>
> **2026-02-07 구현 완료 (P0+P1+P2)**: 아래 "9. 구현 결과" 섹션 참조

---

## 1. 백테스트 개요

### 1.1 Grid Backtest (Phase 1) — 전종목 2개월

216개 조합을 탐색하여 최적의 팩터 가중치 프로필을 찾았습니다.

**탐색 차원 (4개):**
- 팩터 가중치 프로필 8종 (momentum, quality, value, technical, news, supply_demand)
- Smart Money 5D 보너스 3종 (OFF, CURRENT, AGGRESSIVE)
- RSI 과매도 기준 3종 (25, 30, 35)
- RSI+외인 Compound Bonus 3종 (OFF, 5점, 8점)

**Phase 1 결과 요약:**

| 순위 | 프로필 | SM | RSI | CB | IC | IR | Spread(D+5) |
|------|--------|-----|-----|-----|------|------|-------------|
| 1 | QUALITY_VALUE | OFF | 35 | STRONG | +0.130 | +0.797 | +4.12% |
| 2 | QUALITY_VALUE | OFF | 25 | STRONG | +0.128 | +0.791 | +4.08% |
| 3 | QUALITY_VALUE | OFF | 30 | CURRENT | +0.127 | +0.785 | +3.95% |
| ... | BASELINE (현재) | CURRENT | 30 | CURRENT | +0.089 | +0.583 | +2.41% |

**차원별 독립 효과:**

| 차원 | 최적값 | IR | 비고 |
|------|--------|-----|------|
| 가중치 프로필 | QUALITY_VALUE (quality 30, value 25) | 0.797 | BASELINE(0.583) 대비 +37% |
| SM 보너스 | OFF (보너스 없음) | 0.740 | CURRENT(0.671) 대비 +10% |
| RSI 기준 | 무관 (25/30/35 차이 미미) | ~0.710 | 통계적 유의차 없음 |
| Compound Bonus | 무관 (OFF/5/8 차이 미미) | ~0.710 | 통계적 유의차 없음 |

**Phase 1 핵심 인사이트:**
1. **QUALITY_VALUE 프로필이 압도적** — quality(ROE) 30% + value(PBR/PER 역수) 25%
2. **SM 보너스는 OFF가 최적** — smart_money_5d 중립값이 유효 팩터를 희석
3. **RSI/Compound는 무의미한 차원** — 최적화 대상에서 제외 가능

---

### 1.2 LLM Score vs 실제 수익률 (Phase 2) — Watchlist 4주

watchlist_history에 기록된 scout 추천 종목(매일 ~15개)의 LLM 점수와 실제 Forward Return을 비교했습니다.

**전체 IC (Information Coefficient):**

| 지표 | D+5 | D+10 | D+20 |
|------|------|------|------|
| IC (Spearman) | **-0.1523** | -0.1108 | -0.0892 |
| p-value | **0.0183** | 0.0521 | 0.0897 |

- D+5 IC = -0.15 (p=0.018): **통계적으로 유의한 역상관**
- LLM 점수가 높을수록 수익률이 낮음

**LLM 점수 구간별 실제 성과:**

| LLM Score | 종목 수 | D+5 평균 | D+5 Hit Rate | D+10 평균 | D+20 평균 |
|-----------|---------|----------|-------------|-----------|-----------|
| 80+ (최고) | 89 | **-0.09%** | **48%** | -0.52% | -1.23% |
| 70-79 | 112 | +1.24% | 55% | +0.87% | +0.42% |
| 60-69 | 45 | +3.67% | 62% | +2.91% | +3.15% |
| 60 미만 | 12 | **+11.00%** | **92%** | +8.45% | +7.82% |

**LLM 최고점수(80+) 종목이 평균 -0.09%, Hit Rate 48%로 사실상 동전 던지기보다 못합니다.**
**반면 LLM 최저점수(60 미만) 종목이 +11%, Hit Rate 92%로 압도적으로 좋습니다.**

---

## 2. IC 반전 시점 분석

IC가 양수에서 음수로 전환된 정확한 시점을 추적했습니다.

**주간 IC 추이:**

| 기간 | IC | 해석 |
|------|-----|------|
| 1/11 ~ 1/17 | +0.12 | 정상 (점수 높은 종목이 실제 상승) |
| 1/18 ~ 1/20 | +0.05 | 약화 |
| **1/21 ~ 1/24** | **-0.18** | **반전 (점수 높은 종목이 하락)** |
| 1/25 ~ 1/31 | -0.22 | 강한 역상관 |
| 2/1 ~ 2/6 | -0.15 | 역상관 지속 |

**1월 21일이 변곡점이며, 이는 자동차 섹터 고점과 정확히 일치합니다.**

**자동차 섹터 주가 추이 (2025-11 ~ 2026-02):**

| 종목 | 11월 저점 | 1/21 고점 | 6M 수익률 | 이후 하락폭 |
|------|-----------|-----------|-----------|-------------|
| 현대차 | 164,600 | 309,000 | +88% | -15% |
| 현대모비스 | 194,000 | 316,000 | +63% | -13% |
| 한국타이어 | 36,700 | 58,200 | +59% | -14% |
| 기아 | 99,000 | 144,500 | +46% | -13% |

이 종목들은 11월부터 강하게 상승하여 scout 시스템이 높은 점수를 부여했고, 실제로 1월 20일까지는 올바른 판단이었습니다. 문제는 **고점 이후에도 높은 점수를 계속 유지**하여 조정 구간에서 매수를 유도했다는 점입니다.

---

## 3. 코드 변경 영향 분석

1월 15~25일 사이 scout 관련 주요 커밋을 확인했습니다.

| 날짜 | 변경 내용 | IC 반전 원인 여부 |
|------|-----------|------------------|
| 1/15 | 뉴스 기본 점수 12점→6점 (Smart Fallback) | **부분 영향** — 뉴스 없는 종목 상대 순위 변동 |
| 1/15 | 잡주 필터 추가 (시총 500억 미만 제외) | 미미 — 유니버스 변동 |
| 1/16 | 실시간 KOSPI 지수로 Regime 감지 | 미미 — Bull/Bear 판정 민감도 변화 |
| 1/23 | Sector Momentum Penalty (-10점) | IC 반전 **이후** 도입, 원인 아님 |
| 1/23 | Chart Phase Engine (Weinstein 4단계) | IC 반전 **이후** 도입, 원인 아님 |

**결론: IC 반전의 원인은 코드 변경이 아니라, 6개월 급등 섹터의 고점 전환이라는 시장 구조 변화입니다.**

---

## 4. 구조적 문제점 (5가지)

### 4.1 모멘텀 다이버전스 무감지

**현재 코드** (`quant_scorer.py` 444-549행):
- 6개월 모멘텀 (15점): `7.5 + relative_momentum_6m * 0.25` → 0~15점
- 1개월 모멘텀 (5점): `2.5 + relative_momentum_1m * 0.25` → 0~5점
- 모멘텀 안정성 (5점): 6개 월간 구간 중 양수 비율

**문제**: 6M과 1M을 독립적으로 합산만 합니다.

```
현대차 예시 (1/25 시점):
  6M 모멘텀: +88%  → 15/15점 (만점)
  1M 모멘텀: -13%  → 0/5점
  안정성: 5/6 양수 → 4.2/5점
  합계: 19.2/25점 (여전히 높음!)
```

6M이 강한 양수이고 1M이 음수인 상태는 전형적인 "고점 후 조정" 시그널인데, 시스템은 이를 단순 합산하여 여전히 높은 점수를 줍니다. **모멘텀 다이버전스**(장기↑ + 단기↓)를 별도로 감지하는 로직이 없습니다.

### 4.2 Recon Protection의 RSI 감점 무력화

**현재 코드** (`quant_scorer.py` 743-763행):
- 조건: 모멘텀 점수 ≥ 20 AND RSI 50~70
- 효과: RSI 감점 면제, 최소 1.5점 보장
- 의도: "강한 추세 초기에 RSI 50~60을 과매수로 오판하지 말 것"

**문제**: 6개월 급등주는 모멘텀 점수가 거의 항상 20 이상입니다. RSI가 65여도 "추세 초기"로 분류되어 감점을 받지 않습니다. 실제로는 6M +88% 상승 후 RSI 65는 "추세 말기"에 해당하지만, 시스템은 이를 구분하지 못합니다.

### 4.3 Safety Lock이 LLM 경고를 억압

**현재 코드** (`scout_pipeline.py` 371-384행):
```
기본: quant × 0.60 + llm × 0.40

Safety Lock (차이 ≥ 30점):
  quant < llm → quant 75% : llm 25% (정량 보수적)
  llm < quant → quant 45% : llm 55% (정성 보수적)
```

**문제**: "보수적 = 낮은 쪽으로 기울인다"는 설계인데, 이는 LLM이 경고할 때 역효과를 냅니다.

```
시나리오: LLM 40점 (위험 경고) vs Quant 75점 (모멘텀 높음)
  차이 = 35점 → Safety Lock 발동
  llm < quant → quant 45% + llm 55%
  최종 = 75×0.45 + 40×0.55 = 33.75 + 22 = 55.75점

  일반 계산: 75×0.60 + 40×0.40 = 45 + 16 = 61.0점
```

Safety Lock이 발동하면 오히려 점수가 **낮아지긴** 하지만, 여전히 55점대로 RECON tier에 진입 가능합니다. 더 근본적으로, LLM이 "이 종목은 고점이다"라는 질적 판단을 해도 quant의 높은 모멘텀 점수가 이를 압도합니다.

### 4.4 수급 추세 변화 무감지

**현재 코드** (`quant_scorer.py` 1064-1200행):
- 외국인 순매수 (7점): 당일 순매수 / 평균거래량 비율
- 기관 순매수 (5점): 당일 순매수 / 평균거래량 비율
- Smart Money 5D 보너스 (최대 3점): 5일 누적이 양수이고 avg_volume 대비 2% 이상

**문제**: 일별 추세 변화를 보지 않습니다. 외국인이 지난주까지 대량 매수했다가 이번 주부터 매도 전환해도, 5일 누적이 아직 양수이면 보너스를 줍니다. "매수 → 매도 전환"이라는 critical 시그널을 놓칩니다.

### 4.5 LLM이 Calibrator로 설계되어 독립 판단 불가

**현재 구조** (`llm_prompts.py` 629행~):

Hunter 프롬프트가 LLM에게 "정량 점수 ±15~20점 범위 내에서 조정하라"고 지시합니다:
```
"당신은 정량 점수를 미세 조정하는 Calibrator입니다.
정량 점수를 기준으로 ±15~20점 범위 내에서 조정하세요."
```

Quant Score가 75점이면 LLM은 55~95 범위에서만 점수를 줄 수 있습니다. LLM이 "이 종목은 고점이니 30점"이라고 판단하고 싶어도, 프롬프트가 이를 허용하지 않습니다.

---

## 5. 개선 제안 (5가지)

### 5.1 모멘텀 다이버전스 페널티 추가

**위치**: `quant_scorer.py` 모멘텀 점수 계산 마지막 단계

**로직**:
```
IF  6M 모멘텀 > +20%
AND 1M 모멘텀 < -3%
THEN 모멘텀 점수에서 -8점 (최소 0점)

IF  6M 모멘텀 > +30%
AND 1M 모멘텀 < -5%
THEN 모멘텀 점수에서 -12점 (최소 0점) + "Distribution" 태그
```

**기대 효과**: 현대차 같은 "6M +88%, 1M -13%" 종목의 모멘텀 점수가 19.2 → 7.2로 하락

### 5.2 Recon Protection 조건 강화

**위치**: `quant_scorer.py` 743-763행

**현재**: 모멘텀 ≥ 20 AND RSI 50-70 → RSI 감점 면제
**변경**: 모멘텀 ≥ 20 AND RSI 50-**60** AND **1M 모멘텀 > 0** → RSI 감점 면제

추가 조건:
- RSI 60 이상은 보호 대상에서 제외
- 1M 모멘텀이 음수면 (최근 하락 중이면) 보호 해제

### 5.3 Safety Lock 방향 수정

**위치**: `scout_pipeline.py` 371-384행

**현재**: 차이 ≥ 30 → 낮은 쪽 가중치 증가
**변경**:
```
IF llm_score < 40 (LLM이 부정적 판단):
    → llm 가중치를 0.55~0.60으로 상향 (LLM 경고 존중)

IF llm_score > quant_score + 30 (LLM만 과도하게 낙관):
    → quant 가중치를 0.75로 상향 (기존과 동일, quant 신뢰)
```

핵심: LLM이 "위험하다"고 경고할 때는 그 경고를 존중하되, LLM이 "과도하게 낙관"할 때만 quant를 신뢰하는 비대칭 구조.

### 5.4 Recent Peak 감점 (20일 고점 이탈)

**위치**: `quant_scorer.py` 기술적 점수 계산 부분 (신규)

**로직**:
```
peak_20d = MAX(종가, 최근 20일)
current = 현재가
drawdown = (current - peak_20d) / peak_20d

IF drawdown < -5%:  → -3점
IF drawdown < -10%: → -5점
IF drawdown < -15%: → -8점

단, 60일 이동평균 위에 있으면 감점 절반 (건전한 조정 구분)
```

### 5.5 수급 추세 반전 감지

**위치**: `quant_scorer.py` supply_demand 섹션 (신규)

**로직**:
```
외인 최근 5일 순매수 = SUM(최근 1~5일)
외인 이전 5일 순매수 = SUM(최근 6~10일)

IF 이전5일 > 0 AND 최근5일 < 0:
    → "외인 매도 전환" 플래그, 수급 점수 -3점

IF 이전5일 < 0 AND 최근5일 > 0:
    → "외인 매수 전환" 플래그, 수급 점수 +2점 (역발상 보너스)
```

---

## 6. 우선순위 제안

| 순위 | 항목 | 난이도 | 기대 효과 | 이유 |
|------|------|--------|-----------|------|
| 1 | 모멘텀 다이버전스 페널티 | 낮음 | **매우 높음** | 고점 추격의 직접 원인 해소 |
| 2 | Recon Protection 강화 | 낮음 | 높음 | RSI 감점 복원 → 과열주 필터링 |
| 3 | Safety Lock 비대칭 구조 | 중간 | 높음 | LLM 경고를 살림 |
| 4 | Recent Peak 감점 | 낮음 | 중간 | 조정 초기 포착 |
| 5 | 수급 추세 반전 감지 | 중간 | 중간 | 스마트머니 이탈 포착 |

---

## 7. 참고: 현재 팩터 가중치 vs 백테스트 최적

**현재 SHORT_TERM_WEIGHTS** (`quant_constants.py`):
```
rsi_compound:     0.35  (RSI + 외인 복합)
technical_rsi:    0.15
supply_demand:    0.20
quality_roe:      0.10
momentum:         0.05
value:            0.05
news:             0.05
llm_qualitative:  0.05
```

**백테스트 최적 (QUALITY_VALUE 프로필, IR +0.797)**:
```
quality:   0.30  (+200%)
value:     0.25  (+400%)
momentum:  0.15
supply:    0.10
technical: 0.10
news:      0.10
```

현재 가중치는 RSI 복합(35%)에 지나치게 의존하고, quality/value를 과소평가합니다. 백테스트에서는 **ROE/PBR/PER 중심의 가치 투자 팩터**가 한국 시장에서 더 높은 예측력(IR 기준 +37%)을 보였습니다.

---

## 8. 데이터 품질 참고

본 분석 과정에서 STOCK_DAILY_PRICES_3Y 테이블에 **주말/공휴일 데이터가 잘못된 가격으로 삽입**되어 있는 문제를 발견하여, FinanceDataReader로 최근 90일치를 재수집한 후 분석했습니다. 데이터 정제 전에는 삼성전자가 +150% 변동으로 보이는 등 왜곡이 있었으며, 정제 후 Phase 1 IR이 0.681 → 0.797로 17% 개선되었습니다.

KIS API 기반 수집 스크립트(`scripts/collect_full_market_data_parallel.py`)에 주말/공휴일 필터링 로직이 추가되었습니다 (P0, 2026-02-07 완료).

---

## 9. 구현 결과 (2026-02-07)

### 4인 LLM 컨설팅 후 역검증 기반 수정

당초 제안된 5가지 개선안에 대해 4명의 LLM(Gemini/Claude/GPT/DeepSeek) 피드백 + **실제 백테스트 데이터 역검증**을 거쳐, 데이터가 지지하는 변경만 적용했습니다.

#### 역검증에서 뒤집힌 가정

| 당초 가정 | 실제 데이터 | 결론 |
|-----------|------------|------|
| 모멘텀 다이버전스(6M↑1M↓) = 위험 | D+5 +2.38% (baseline +1.38%) | **눌림목 매수 시그널. 페널티 미적용** |
| 고점 근접(DD<-5%) = 위험 | DD<-15% → D+5 +2.04% | **mean reversion 효과. 단순 감점 불가** |
| RSI>60 보호 필요 | RSI>60 hit rate 47% (baseline 49%) | **보호 해제 타당** |
| 외인 매도전환 = 위험 | 양→음 hit rate 47% (baseline 51%) | **감점 타당 (-2점)** |

#### 적용된 변경 (P0 + P1)

**P0: KIS 데이터 품질** (`scripts/collect_full_market_data_parallel.py`)
- 주말(토/일) 데이터 삽입 방지 (weekday 체크)
- 거래량 0인 비거래일 데이터 스킵

**P1-2: Recon Protection 강화** (`shared/hybrid_scoring/quant_scorer.py`)
- RSI 보호 범위: 50-70 → **50-59** (RSI 60+ 보호 해제)
- 1M 모멘텀 양수 조건 추가 (최근 하락 중이면 보호 불가)
- Dry-run: 38개 watchlist 중 **9개 종목** 보호 해제

**P1-3: 고점 근접 + 과열 조합 감점** (`shared/hybrid_scoring/quant_scorer.py`)
- DD > -3% AND RSI > 70 → -1.5점
- DD > -2% AND RSI > 65 → -1.0점
- 단순 drawdown 감점은 미적용 (mean reversion 역효과)
- Dry-run: **10개 종목** 감점 (금융주 위주)

**P1-4: 수급 추세 반전 감지** (`shared/hybrid_scoring/quant_scorer.py`)
- 외인 순매수 이전5D → 최근5D 방향 비교
- 양→음 (매도전환): **-2점** (hit rate 47%)
- 음→양 (매수전환): **+1.5점** (hit rate 54%)
- Dry-run: **17개 종목** 영향 (8개 매도전환, 9개 매수전환)

#### 미적용 (데이터 미지지)

| 당초 제안 | 미적용 이유 |
|-----------|------------|
| 5.1 모멘텀 다이버전스 -8/-12점 | 실제로 눌림목 매수 시그널 (+2.38%) |
| 5.4 단순 drawdown -3/-5/-8점 | mean reversion 효과 (+2.04%) |
| 7. QUALITY_VALUE 가중치 전환 | out-of-sample 과적합 위험 (민지 지적) |

#### P2 구현 완료 (2026-02-07)

**P2-1: LLM Calibrator 확대 + risk_tag + Veto** (`shared/llm_prompts.py`, `shared/llm_constants.py`, `services/scout-job/scout_pipeline.py`)
- Hunter/Judge 보정 범위: ±15~20점 → **±30점** (강한 악재/호재에 대한 LLM 표현력 확대)
- **risk_tag 신규 출력**: BULLISH / NEUTRAL / CAUTION / DISTRIBUTION_RISK (점수와 독립)
- **Veto Power**: DISTRIBUTION_RISK 태그 → `is_tradable=False`, `trade_tier=BLOCKED` (워치리스트 제외)
- ANALYSIS_RESPONSE_SCHEMA에 risk_tag 필드 추가 (required)

**P2-2: Safety Lock 비대칭 구조** (`services/scout-job/scout_pipeline.py`)
- 기존: LLM > Quant+30 → 75:25, LLM < Quant-30 → 45:55
- 변경:
  - LLM이 과잉 낙관 (Quant < LLM, diff≥30): **Quant 75% + LLM 25%** (유지, 낙관 억제)
  - LLM이 경고 (LLM < Quant, diff≥30): **Quant 40% + LLM 60%** (LLM 경고 존중, 기존 45:55 → 40:60)
  - LLM < 40점 (명시적 경고): **Quant 45% + LLM 55%** (diff<30이어도 LLM 가중치 상향)

**P2 미적용 (HOLD)**
- QUALITY_VALUE 가중치 전환 (rolling window out-of-sample 검증 후)
