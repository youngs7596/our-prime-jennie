# Session Handoff: P0 트레이딩 로직 개선 & Ollama Gateway Rate Limit 최적화

## 요약 (Summary)
3현자 Council 합의에 따른 P0 즉시 실행 항목 3가지 구현 완료. 이후 Scout 200종목 테스트 중 발견된 ollama-gateway embed 429 이슈 해결 및 모델별 차등 rate limit 구현.

## 변경 사항 (Changes)

### P0 트레이딩 로직 (3건)
- **`shared/redis_cache.py`**: 손절 쿨다운 함수 3개 추가 (`set_stoploss_cooldown`, `get_stoploss_cooldown`, `is_stoploss_blacklisted`)
- **`services/buy-scanner/opportunity_watcher.py`**:
  - BEAR/STRONG_BEAR Market Regime Gate 추가 (`ENABLE_BEAR_ENTRY_BLOCK=true`)
  - 손절 종목 5거래일 쿨다운 체크 추가 (SL Cooldown Gate)
  - VOLUME_BREAKOUT_1MIN 기본 비활성화 (`ENABLE_VOLUME_BREAKOUT_1MIN=false`)
- **`services/sell-executor/executor.py`**: Stop Loss 발생 시 Redis 쿨다운 설정 (TTL 5일)

### Ollama Gateway Rate Limit 최적화
- **`services/ollama-gateway/main.py`**: 엔드포인트별 + 모델별 차등 rate limit 구현
  - embed: 3000/min (경량 작업, GPU 부하 낮음)
  - exaone (FAST): 120/min (별도 Redis 버킷 `ollama_fast`)
  - heavy models (deepseek 등): 60/min (기존 `ollama_global`)
  - 동적 `key_func` + `get_dynamic_generate_limit` 함수로 요청 body의 model 필드 기반 라우팅

### 환경변수 정리
- **`docker-compose.yml`**:
  - ollama-gateway에 `OLLAMA_RATE_LIMIT_FAST`, `OLLAMA_RATE_LIMIT_EMBED`, `OLLAMA_FAST_MODELS` 추가
  - news-collector의 불필요한 `SCOUT_UNIVERSE_SIZE=5` 하드코딩 제거
- **`infrastructure/env-vars-wsl.yaml`**: `SCOUT_UNIVERSE_SIZE` 200으로 원복

### Redis Stream 수정 (수동)
- `stream:news:raw`에 consumer group `group_analyzer`, `group_archiver` 수동 생성 (NOGROUP 에러 해결)

### 테스트
- **`tests/shared/test_redis_cache.py`**: 손절 쿨다운 테스트 8개 추가
- **`tests/services/buy-scanner/test_opportunity_watcher_new.py`**: Regime Gate(5), SL Cooldown(2), Volume Breakout Disable(2) 테스트 추가
- 전체 141개 테스트 통과 (107 redis + 16 buy-scanner + 18 sell-executor)

## 현재 상태 (Current State)
- Scout가 200종목 기준으로 실행 중 (DeepSeek v3.2 Cloud + kure-v1 embed)
- 194개 후보 발굴 → Phase 2 Hunter 분석 진행 중
- embed 429 이슈는 3000/min으로 증가하여 다음 run부터 해결 예정

## 다음 단계 (Next Steps)
- [ ] 장 개장 후 Scout 200종목 정상 동작 확인 (429 없이 완주하는지)
- [ ] P0 기능 실거래 검증: Regime Gate, SL Cooldown, VOLUME_BREAKOUT 비활성화 로그 확인
- [ ] news-archiver가 ollama-gateway 대신 직접 ollama(11434)를 호출하는 문제 — gateway 경유로 통합 검토
- [ ] 모멘텀 소스 top_n=30 확대 여부 검토 (현재 KOSPI 200과 대부분 중복)

## Context for Next Session
- `services/ollama-gateway/main.py` — rate limit 로직 (line 75~130)
- `services/buy-scanner/opportunity_watcher.py` — P0 gates (Regime Gate, SL Cooldown)
- `services/sell-executor/executor.py` — 손절 쿨다운 설정 (line ~295)
- `shared/redis_cache.py` — stoploss cooldown 함수 (line ~1379)
- `docker-compose.yml` — ollama-gateway 환경변수, scout-worker 설정

## 롤백 방법
- VOLUME_BREAKOUT: `ENABLE_VOLUME_BREAKOUT_1MIN=true`
- Regime Gate: `ENABLE_BEAR_ENTRY_BLOCK=false`
- SL Cooldown: `STOPLOSS_COOLDOWN_DAYS=0` (TTL 0 = 즉시 만료)
- Embed Rate Limit: `OLLAMA_RATE_LIMIT_EMBED=300 per minute` (원복)
