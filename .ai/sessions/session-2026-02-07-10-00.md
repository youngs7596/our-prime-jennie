# Session 2026-02-07 10:00 - vLLM 부팅 안정화 & 인프라 정리

## 배경
WSL 재부팅 후 vLLM 컨테이너가 안 올라와 ollama-gateway 서킷브레이커가 열리고, news-archiver/analyzer 등 임베딩+추론 의존 서비스가 모두 실패.
원인: `systemd_autostart.sh`가 `--profile gpu`를 누락, vLLM `--model` 옵션 deprecation 경고.

## 변경 사항

### 1. vLLM `--model` → positional argument
- `docker-compose.yml`: vllm-llm, vllm-embed 모두 `--model` 제거
- vLLM 0.13에서 `--model` 옵션 제거 예정, positional argument로 변경

### 2. vLLM 프로파일 `gpu` → `infra` 통합
- GPU 전용 머신이므로 별도 프로파일 불필요
- `docker-compose.yml`: vllm-llm, vllm-embed `profiles: ["gpu"]` → `["infra"]`
- 부팅 흐름: 3단계(infra→gpu→real) → 2단계(infra→real)로 단순화

### 3. `depends_on`으로 서비스 순서 보장
- `ollama-gateway`에 `depends_on` 추가:
  - `vllm-llm: condition: service_healthy, required: false`
  - `vllm-embed: condition: service_healthy, required: false`
- Docker Compose가 vLLM healthy 대기를 자체 처리 → 스크립트 수동 폴링 제거

### 4. `systemd_autostart.sh` 단순화
- 별도 `--profile gpu up -d` + vLLM health 폴링 루프 제거
- `infra up -d` → rabbitmq/redis healthy 확인 → `real up -d` (2단계)
- chromadb health check 제거 (서비스 정의 없이 orphan으로 남아있던 상태)

### 5. systemd service 파일 동기화
- `ExecStop`에 `--profile infra` 추가 (vLLM 포함 전체 종료)
- `infrastructure/` 및 `scripts/` 양쪽 동기화

### 6. chromadb orphan 정리
- `docker-compose.yml`: 7개 서비스 `depends_on`에서 chromadb 참조 제거
- orphan 컨테이너 삭제 완료

### 7. VRAM 최적화 & 동적 토큰 클램핑
- vllm-llm: `gpu-memory-utilization` 0.82 → **0.90** (KV cache 1,840 → 9,792 토큰)
- vllm-embed: `gpu-memory-utilization` 0.10 → **0.05** (KURE-v1 1.06GB 모델에 충분)
- ollama-gateway: `VLLM_MAX_MODEL_LEN=4096` 환경변수 명시
- 동적 max_tokens 클램핑: 프롬프트 길이 추정 후 available tokens 계산
  - 기존: 고정 절반 cap (`max_model_len // 2`)
  - 변경: `available = max_model_len - estimated_input - 64` (한국어 ~2 char/token 추정)

## 부팅 타이밍 측정 결과 (캐시 히트 기준)
| 이벤트 | 소요 시간 |
|---|---|
| 스크립트 시작 → infra 시작 | ~4초 |
| vllm-embed healthy | ~51초 |
| vllm-llm healthy | ~120초 (start_period 포함) |
| 전체 스크립트 완료 | **~88초** |

## 수정 파일
- `docker-compose.yml` (vLLM command, profile, depends_on, VRAM, chromadb 제거)
- `scripts/systemd_autostart.sh` (gpu 프로파일 로직 제거, chromadb 제거)
- `infrastructure/my-prime-jennie.service` (ExecStop)
- `scripts/my-prime-jennie.service` (ExecStop)
- `services/ollama-gateway/main.py` (동적 토큰 클램핑)

## 시스템 상태
- 전체 서비스 정상 가동 확인
- news-analyzer: 뉴스 분석 정상 (엔씨소프트 65점, 엘앤에프 85점, DB하이텍 85점 등)
- archiver pending 20,862건 ACK 정리 완료 (collector 재수집으로 자연 보충)

## 주의사항
- vLLM `max-model-len 8192`는 0.82 utilization에서 KV cache 부족으로 hang 발생 → 4096 유지 필요
- HF 캐시 미스 시 인터넷 재다운로드 ~6분 추가 소요 (정상 캐시 히트: ~2분)
