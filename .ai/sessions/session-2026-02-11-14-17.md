# Session Handoff: Macro Council 구조화 JSON 파이프라인 + 시장 분석 정리

## 요약 (Summary)
Macro Council 파이프라인을 subprocess+regex 방식에서 구조화 JSON 직접 호출로 전환. 전략가/리스크분석가/수석심판 3단계 파이프라인 구축 후, 토큰 효율화를 위해 개별 종목(key_stocks/risk_stocks/opportunity_stocks)과 key_themes를 전략가 출력에서 제거. sector_signals는 trading_context.py 폴백에 필요하여 복원.

## 변경 사항 (Changes)

### Macro Council 구조화 JSON 파이프라인
- `scripts/run_macro_council.py`: subprocess+regex 제거 → `generate_json()` / `generate_json_with_thinking()` 직접 호출
  - 전략가(DeepSeek v3.2) → 리스크분석가(DeepSeek v3.2) → 수석심판(Claude Opus 4.6 Extended Thinking)
  - 비용: ~$0.215/회 ($0.43/일), 기존 대비 67% 절감
- `shared/llm_constants.py`: `MACRO_STRATEGIST_SCHEMA`, `MACRO_RISK_ANALYST_SCHEMA`, `MACRO_CHIEF_JUDGE_SCHEMA` 추가
- `shared/llm_providers.py`: `ClaudeLLMProvider.generate_json_with_thinking()` 메서드 추가, GPT-5.2 REASONING_MODELS 등록
- `prompts/council/`: 전략가, 리스크분석가, 수석심판 프롬프트 파일 3개 신규
- `shared/macro_insight/daily_insight.py`: risk_stocks, opportunity_stocks 필드 추가 (DB DDL 포함)
- `services/dashboard/backend/main.py`: API에 risk_stocks, opportunity_stocks 필드 추가
- `tests/scripts/test_macro_council_pipeline.py`: 31개 테스트 신규

### 토큰 효율화 — 개별 종목/테마 제거
- `prompts/council/macro_strategist.txt`: key_themes, key_stocks, risk_stocks, opportunity_stocks 출력 제거
- `shared/llm_constants.py`: MACRO_STRATEGIST_SCHEMA에서 해당 필드 제거
- `services/dashboard/frontend/src/pages/MacroCouncil.tsx`: 시장 분석 섹션 4개 카드 제거 (핵심 테마, 위험 종목, 기회 종목, 섹터별 신호 UI)

### sector_signals 복원
- 전략가 프롬프트/스키마에서 sector_signals 다시 추가 (trading_context.py 섹터 회피 폴백에 필요)
- merge_council_outputs, save_macro_insight에서 sector_signals 전달 복원

### DB DDL (이미 실행됨)
```sql
ALTER TABLE DAILY_MACRO_INSIGHT
  ADD COLUMN RISK_STOCKS JSON DEFAULT NULL AFTER KEY_STOCKS,
  ADD COLUMN OPPORTUNITY_STOCKS JSON DEFAULT NULL AFTER RISK_STOCKS;
ALTER TABLE DAILY_MACRO_INSIGHT MODIFY COLUMN REGIME_HINT VARCHAR(200) DEFAULT NULL;
```

## 배포 상태
- Dashboard (backend + frontend): 배포 완료
- Airflow (scheduler + webserver): 배포 완료

## 주요 발견 — Chief Judge 빈 배열 문제
- 02-10, 02-11 데이터에서 수석심판이 strategies_to_favor/avoid, sectors_to_favor/avoid를 빈 배열로 반환
- 원인: 높은 political_risk_level(high)에서 LLM이 추천/배제를 거부
- 시스템 동작: 빈 배열 시 risk_off_level 기반 폴백으로 전략 필터링, position_size_pct(80%) + stop_loss_adjust_pct(130%)만 적용
- sector_signals 복원으로 섹터 회피 폴백 정상화

## 다음 단계 (Next Steps)
- [ ] Chief Judge 프롬프트에 "최소 1개 이상" 전략/섹터 추천 유도 검토
- [ ] 내일 07:30 macro_council DAG 실행 후 sector_signals 정상 생성 확인
- [ ] CLAUDE.md 매크로 Council 섹션 업데이트 (sector_signals 복원 반영)

## Context for Next Session
- `shared/macro_insight/trading_context.py`: 빈 배열 시 폴백 로직 (L106-133, L584-598)
- `prompts/council/macro_chief_judge.txt`: 수석심판 프롬프트 (전략/섹터 빈 배열 문제)
- `tests/scripts/test_macro_council_pipeline.py`: 31개 테스트
