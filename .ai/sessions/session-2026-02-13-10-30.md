# Session Handoff: 2026-02-13 10:30

## 세션 주제
동적 섹터 예산 (Dynamic Sector Budget) 구현 + cancel_order 버그 수정 + 계좌 동기화

## 배경
- Scout watchlist(20개)가 핫 섹터(금융 등) 8/20 슬롯 독점 → 다른 섹터 기회 상실
- Portfolio Guard 고정 MAX_SECTOR_STOCKS=3으로 차단 → buy-executor 반복 헛수고
- cancel_order 미구현으로 지정가 주문 후 AttributeError → DB 미기록 ghost 매수 발생

## 주요 작업

### 1. 동적 섹터 예산 구현 (핵심 기능)
- **`shared/sector_budget.py`** (신규): 섹터 모멘텀 기반 티어(HOT/WARM/COOL) 배정 + Greedy 선정 알고리즘
  - HOT (p75 & >0%): watchlist_cap=5, portfolio_cap=5
  - WARM (기본): watchlist_cap=3, portfolio_cap=3
  - COOL (p25 & <0% or FALLING_KNIFE): watchlist_cap=2, portfolio_cap=2
- **`services/scout-job/scout.py`** (수정): watchlist 선정 시 sector_budget 적용 (lines 1286-1358)
  - sector_analysis → 대분류 집계 → 티어 배정 → effective_cap 계산 → Greedy 선정
  - Redis `sector_budget:active` 키에 저장 (TTL 24h)
  - 비활성/예외 시 기존 top-N fallback
- **`shared/portfolio_guard.py`** (수정): `_get_dynamic_sector_cap()` 메서드 추가
  - Redis에서 동적 한도 로드 → 고정 MAX_SECTOR_STOCKS 대신 사용
  - Redis 실패/비활성 시 기존 고정값 fallback

### 2. cancel_order 버그 수정 (프로덕션 버그)
- **증상**: `MOMENTUM_LIMIT_ORDER_ENABLED=true` 상태에서 지정가 주문 후 `self.kis.cancel_order()` → AttributeError
- **영향**: 성공한 주문이 DB에 미기록 → 시스템이 보유 종목 모름 → 중복 매수 (ghost purchase)
- **수정**:
  - `services/kis-gateway/main.py`: `/api/trading/cancel` POST 엔드포인트 추가
  - `shared/kis/gateway_client.py`: `cancel_order()` 메서드 추가

### 3. 계좌 동기화
- `utilities/sync_portfolio_from_account.py` 실행
- 9→10건 불일치 발견 → 동기화 완료 (12종목 일치)
- 재배포 후 2차 확인: 12/12 완벽 일치, 추가 ghost 매수 없음

### 4. 동적 섹터 예산 + Portfolio Guard 연동 검증
- 금융 5개 보유 → 모든 티어(HOT/WARM/COOL)에서 추가 금융 매수 차단 확인
- effective_watchlist_cap = 1 (파이프라인 버퍼만)
- 유통 3개 보유 → WARM cap=3 도달, 추가 매수 차단 확인

## 수정/생성 파일
| 파일 | 변경 | 설명 |
|------|------|------|
| `shared/sector_budget.py` | 신규 | 동적 섹터 예산 핵심 모듈 |
| `services/scout-job/scout.py` | 수정 | watchlist 선정에 sector_budget 적용 |
| `shared/portfolio_guard.py` | 수정 | 동적 cap 로드 (Redis) |
| `shared/settings/registry.py` | 수정 | DYNAMIC_SECTOR_BUDGET_ENABLED 설정 |
| `infrastructure/env-vars-wsl.yaml` | 수정 | DYNAMIC_SECTOR_BUDGET_ENABLED=true |
| `services/kis-gateway/main.py` | 수정 | /api/trading/cancel 엔드포인트 |
| `shared/kis/gateway_client.py` | 수정 | cancel_order() 메서드 |
| `services/scout-job/scout_pipeline.py` | 수정 | market_flow 수급 데이터 + snapshot null 방어 (기존 미커밋) |
| `shared/db/factor_repository.py` | 수정 | NEWS_DATE datetime→date 변환 (기존 미커밋) |
| `tests/shared/test_sector_budget.py` | 신규 | 36개 테스트 |
| `tests/shared/test_portfolio_guard.py` | 수정 | 동적 cap 테스트 4개 추가 |

## 테스트 결과
- `tests/shared/test_sector_budget.py`: 36 passed
- `tests/shared/test_portfolio_guard.py`: 28 passed (기존 24 + 동적 cap 4)
- 전체 shared: 1202 passed, 1 skipped
- 전체 services: 174 passed

## 커밋 & 배포
- **커밋**: `6ba26a2 feat: 동적 섹터 예산 + cancel_order 버그 수정`
- **배포**: buy-executor, kis-gateway, scout-job 3개 서비스 재빌드 완료

## 다음 단계 (TODO)
- [ ] 다음 scout 실행 시 `[Dynamic Sector Budget]` 로그 확인 (HOT/WARM/COOL 분류 정상 여부)
- [ ] 장중 섹터 모멘텀 변화에 따른 티어 변동 모니터링
- [ ] 금융 5종목 보유 상태에서 watchlist 구성 변화 관찰 (금융 슬롯 감소 → 다른 섹터 진입)
- [ ] ghost 매수 재발 여부 확인 (cancel_order 수정 후)

## 롤백 방법
- `DYNAMIC_SECTOR_BUDGET_ENABLED=false` → 즉시 기존 동작 복원 (코드 변경 없이)
- sector_analysis 비어있으면 자동 스킵
- Redis 장애 시 Portfolio Guard가 기존 고정값(MAX_SECTOR_STOCKS=3) 사용

## Context for Next Session
- `shared/sector_budget.py`: 핵심 모듈 (aggregate → tiers → budget → select)
- `services/scout-job/scout.py` lines 1286-1358: watchlist 선정 sector_budget 적용 부분
- `shared/portfolio_guard.py`: `_get_dynamic_sector_cap()` 메서드
- Redis key: `sector_budget:active` (TTL 24h, JSON)
- 현재 보유: 12종목 (금융 5, 유통 3, 기타)
