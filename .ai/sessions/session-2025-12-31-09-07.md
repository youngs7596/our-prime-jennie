# Session Handoff: 종목별 특성 반영 매수/매도 임계치 시스템

## 요약 (Summary)
종목별 특성(변동성, 유동성, RSI 분포)을 반영해 매수/매도 임계치를 개별화하는 시스템을 구축했습니다. 기존에는 RSI/거래량/Tier2 조건이 모든 종목에 동일하게 적용되어 시장 상승에도 매수 신호가 발생하지 않는 문제가 있었는데, 이를 해결하기 위해 종목별 오버라이드 인프라와 자동 프로파일러를 구현했습니다.

## 변경 사항 (Changes)

### 핵심 변경
- `shared/config.py`: 종목별 설정 조회 API 추가
  - `get_for_symbol()`, `get_int_for_symbol()`, `get_float_for_symbol()`, `get_bool_for_symbol()`
  - 우선순위: 종목별 키(SYMBOL_{code}__*) > 파일 오버라이드 > 전역 설정
- `shared/symbol_profile.py`: 종목 프로파일러 모듈 신설
  - RSI 분포(P20/P80), 평균 거래량 기반 임계치 자동 산출
  - `config/symbol_overrides.json` 파일 병합 유틸
- `shared/settings/registry.py`: 종목별 튜닝 키 등록
  - `TIER2_VOLUME_MULTIPLIER`, `TIER2_RSI_MIN/MAX`, `BUY_RSI_OVERSOLD_BULL_THRESHOLD`, `SELL_RSI_OVERBOUGHT_THRESHOLD`

### 서비스 적용
- `services/buy-scanner/scanner.py`: RSI 과매도/Tier2 조건에 종목별 설정 적용
- `services/price-monitor/monitor.py`: RSI 과열 매도 기준에 종목별 설정 적용

### 스크립트/운영
- `scripts/refresh_symbol_profiles.py`: 프로파일 산출 배치 스크립트
  - `--universe`: Scout 전체 universe (KOSPI 200개) 대상
  - `--codes`: 특정 종목만 지정
  - `--dry-run`: 파일 쓰지 않고 로그만
- 크론잡 등록: 매일 평일 16:40 실행 (Scout universe 전체)

### 설정 파일
- `config/symbol_overrides.json`: 200개 종목 프로파일 저장 완료

### 테스트
- `tests/shared/test_config.py`: 종목별 설정 조회 테스트 추가
- `tests/shared/test_symbol_profile.py`: 프로파일러 유닛 테스트 추가
- 전체 테스트 통과: Unit 58 passed + Integration 5 passed

## 현재 상태 (Current State)
- 200개 종목에 대해 종목별 임계치가 `symbol_overrides.json`에 적용됨
- 크론잡으로 매일 장 마감 후 자동 갱신 설정 완료
- buy-scanner/price-monitor가 종목별 특성을 반영해 판단 수행

## 다음 단계 (Next Steps)
- [ ] 🔴 실제 운영에서 매수 신호 발생 여부 모니터링 (기존 대비 개선 확인)
- [ ] 🟡 필요시 특정 종목 수동 튜닝 (DB 키 `SYMBOL_{code}__*` 또는 JSON 직접 편집)
- [ ] 🟡 프로파일 산출 규칙 미세 조정 (클리핑 범위, 분위수 기준 등)
- [ ] 🟢 대시보드에서 종목별 오버라이드 현황 시각화 (선택)

## Context for Next Session
다음 세션 시작 시 아래 파일들을 먼저 읽어주세요:
- `shared/config.py` - 종목별 설정 조회 로직
- `shared/symbol_profile.py` - 프로파일 산출 규칙
- `config/symbol_overrides.json` - 현재 적용된 종목별 오버라이드
- `services/buy-scanner/scanner.py` (660~860 라인) - Tier2 조건 적용 부분

## 핵심 결정사항 (Key Decisions)
1. **파일 기반 오버라이드 선택**: DB 마이그레이션 없이 `symbol_overrides.json`으로 관리
2. **분위수 기반 자동 산출**: RSI P20/P80으로 과매도/과열 기준 결정
3. **유동성 기반 거래량 배수**: 평균 거래량 20만 미만은 1.05x, 50만 미만 1.1x, 이상 1.2x
4. **Scout universe 전체 적용**: Watchlist만이 아닌 KOSPI 200개 전체로 확장

## 주의사항 (Warnings)
- 크론잡이 DB 접속 환경변수를 인라인으로 포함하고 있음 (비밀번호 노출 주의)
- `symbol_overrides.json`을 직접 편집할 경우 JSON 형식 검증 필요
- 프로파일러는 일봉 데이터 최소 30일 필요 (부족 시 스킵)

## 크론 타임라인 (평일)
| 시간 | 작업 |
|------|------|
| 16:00 | 가격 데이터 수집 |
| 16:40 | **종목 프로파일 업데이트** + AI 성과 분석 |
| 16:50 | 일일 브리핑 |
| 17:00 | 전략 피드백 업데이트 |

