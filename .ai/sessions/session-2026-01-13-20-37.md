# Session Handoff: DB Transaction Error Resolved

## 요약 (Summary)
ActivePortfolio 리팩토링 후 발생한 Integration Test의 `RuntimeError` (DB Error)를 해결했습니다. 주요 원인은 MariaDB 전용 문법(`ON DUPLICATE KEY UPDATE`)이 테스트용 SQLite 환경에서 지원되지 않는 점과, Repository가 여전히 Legacy 테이블을 참조하는 문제였습니다. 두 가지를 모두 수정하여 테스트를 통과시켰습니다.

## 변경 사항 (Changes)
- `shared/database/trading.py`: `_is_sqlite` 헬퍼 함수 추가 및 `save_to_watchlist`, `_execute_trade_and_log_sqlalchemy` 함수 내에서 DB Dialect에 따라 조건부 SQL(MariaDB: UPSERT, SQLite: SELECT+INSERT/UPDATE) 실행 로직 구현.
- `shared/db/repository.py`: `get_active_portfolio` 함수가 Legacy `PORTFOLIO` 테이블 대신 신규 `ACTIVE_PORTFOLIO` 모델을 조회하도록 수정.
- `tests/integration/conftest.py`: `mock_scope` 픽스처가 세션 종료 시 `session.commit()`을 수행하도록 변경하여 In-memory SQLite 데이터 영속성 보장.
- `tests/integration/test_e2e_pipeline.py`: 수정 후 `test_buy_and_sell_flow` 테스트 통과 확인.

## 다음 단계 (Next Steps)
- **Dashboard Verification**: `repository.py` 수정(`ActivePortfolio` 조회)이 대시보드 포트폴리오 뷰에 정상 반영되는지 확인 필요.
- **Legacy Cleanup**: `PORTFOLIO` 테이블 완전히 제거 및 관련 코드 삭제 마무리.
- **Monitoring**: 실제 매매 시 `ActivePortfolio` 데이터가 정상 누적되는지 `TRADING_MODE=REAL` 환경에서 모니터링.
