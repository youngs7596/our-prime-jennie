# Session Handoff: Sell Logic Hardening & WebSocket Streams

## 요약 (Summary)
이번 세션에서는 KIS API 연결 안정성을 위한 Redis Streams 기반 WebSocket 아키텍처를 구현하고, 매도 로직의 안정성을 위해 Death Cross 민감도 조정 및 Redis Lock 기반 중복 매도 방지 기능을 추가했습니다.

## 변경 사항 (Changes)
- **KIS Gateway**: `KISWebSocketStreamer` 구현, `/api/realtime/subscribe` 엔드포인트 추가, Redis Streams 발행 로직 추가.
- **Client Services**: `buy-scanner`, `price-monitor`가 Redis Streams를 구독하도록 변경 (`shared/kis/stream_consumer.py` 활용).
- **Sell Logic**:
  - `shared/strategy.py`: `check_death_cross` 함수에 `gap_threshold` (기본 0.2%) 적용. 5일선-20일선 단순 교차 외에 0.2% 이상 이격 발생 시에만 매도 신호 생성.
  - `services/sell-executor/executor.py`: `execute_sell_order` 진입 시 `lock:sell:{stock_code}` (TTL 10초) 락 획득 시도. 실패 시 스킵하여 중복 매도 방지.
- **Tests**:
  - `tests/shared/test_strategy_death_cross_gap.py`: Death Cross 이격률 로직 검증 테스트 신규 생성.
  - `tests/services/sell-executor/test_sell_executor.py`: Redis Lock 동작 검증 테스트 추가.

## 다음 단계 (Next Steps)
- [ ] **KIS WebSocket 모니터링**: Redis Streams 방식의 안정성을 며칠간 모니터링하며 "Connection reset" 에러 재발 여부 확인.
- [ ] **매도 신호 빈도 관찰**: Death Cross 민감도 조정이 실제 매도 빈도에 미치는 영향 분석 (너무 둔감해졌는지, 노이즈가 줄었는지 등).
- [ ] **통합 테스트**: 실제 장 운영 시간 중 매수/매도 사이클 전체에 대한 통합 테스트(E2E) 수행 권장.
