# Session Handoff: Airflow 배치 최적화 & 중복 DAG 정리

**일시**: 2026-02-06 16:10 KST
**브랜치**: development

## 작업 요약 (What was done)

### 1. weekly_factor_analysis 중복 수집 제거
- Step 1~4(뉴스, 감성태깅, DART, 수급)는 별도 DAG/서비스가 이미 담당
- DAG에서 `--analysis-only` 플래그 추가 → Step 6(팩터 분석)만 실행
- 실행 시간: ~20분 → ~3-5분

### 2. collect_investor_trading 불필요 sleep 제거
- KIS Gateway가 이미 `19/sec` rate limit을 걸고 있는데, 스크립트에서 종목당 0.5초 sleep을 또 걸고 있었음
- 이중 제한 제거 → ~26분 → ~5-6분

### 3. collect_daily_prices(FDR) 중복 DAG 제거
- `daily_market_data_collector`(KIS API, 16:00)가 동일 테이블(`stock_daily_prices_3y`)에 동일 데이터를 이미 수집
- FDR 기반 `collect_daily_prices`(18:15)는 완전 중복 → DAG 삭제
- 부수 효과: FDR API hang으로 인한 타임아웃 실패 문제도 해소

### 4. collect_prices_fdr.py 타임아웃 추가 (참고용, DAG는 삭제됨)
- `future.result(timeout=60)` 추가 — FDR API hang 시 개별 종목 skip
- DAG는 삭제했지만, 수동 실행 시를 위해 개선 유지

### 5. enhanced_macro_collection pykrx 중복 수집 스킵
- 12:00 실행 시 `enhanced_macro_quick`(11:30)이 이미 pykrx 수집했으므로 스킵
- 07:00, 18:00은 장외 시간이라 quick이 안 돌므로 pykrx 포함 유지

## 변경 파일

| 파일 | 변경 내용 |
|------|----------|
| `dags/host_consolidated_dag.py` | weekly_factor_analysis에 `--analysis-only` 추가 |
| `dags/utility_jobs_dag.py` | `collect_daily_prices` DAG 정의 삭제 |
| `dags/enhanced_macro_collection_dag.py` | 12:00 실행 시 pykrx 스킵 분기 |
| `scripts/collect_investor_trading.py` | sleep 2곳 제거 |
| `scripts/weekly_factor_analysis_batch.py` | docstring 업데이트 |
| `scripts/collect_prices_fdr.py` | future.result(timeout=60) 추가 |

## 현재 상태 (Current State)

- **Airflow DAG**: 16개 → 15개 (collect_daily_prices 제거)
- **중복 DAG**: 없음 (전체 점검 완료)
- **커밋**: origin/development 대비 13 commits ahead (push 안 함)
- **Working tree**: clean

## 다음 할 일 (Next Steps)

- [ ] `git push origin development` (13개 커밋 push 필요)
- [ ] collect_investor_trading sleep 제거 후 실제 실행 시간 확인
- [ ] weekly_factor_analysis --analysis-only 금요일 22:00 실행 결과 확인
- [ ] CLAUDE.md DAG 스케줄 테이블 업데이트 (실제 DAG 목록과 불일치)

## Context for Next Session

- `dags/utility_jobs_dag.py` — collect_daily_prices 제거된 상태
- `dags/host_consolidated_dag.py` — weekly_factor_analysis --analysis-only
- `dags/enhanced_macro_collection_dag.py` — 12:00 pykrx 스킵
- `scripts/collect_investor_trading.py` — sleep 제거

## 핵심 결정사항 (Key Decisions)

- **weekly_factor_analysis**: Step 1~4 데이터 수집은 별도 DAG/서비스 책임으로 분리
  - news-collector/news-analyzer(상시), collect_dart_filings(18:45), collect_investor_trading(18:30)
  - full-refresh가 필요한 경우만 `--full-refresh`로 수동 실행
- **collect_daily_prices 삭제**: daily_market_data_collector(KIS API)와 완전 중복
- **sleep 제거**: KIS Gateway rate limit이 이미 속도를 제어하므로 스크립트 레벨 sleep은 불필요

## 주의사항 (Warnings)

- 13개 커밋이 아직 push되지 않음
- collect_quarterly_financials는 별도 DAG 없음 — 분기 1회 수동 `--full-refresh` 필요
