# Session Handoff: 정치 뉴스 & 투자자 수급 Council 통합

**Date**: 2026-02-02 23:30 KST
**Topic**: 정치/지정학적 뉴스 + 투자자 수급 데이터를 Council LLM 분석에 통합

## 배경

트럼프 대통령이 새 연준의장 후보를 지명한다는 뉴스가 KOSDAQ 급락을 유발했으나, 기존 매크로 시스템에서 이를 감지하지 못함. 사용자 피드백에 따라 규칙 기반 점수 계산 대신 Council LLM이 직접 정치 리스크를 평가하도록 변경.

## 완료된 작업

### 1. PoliticalNewsClient (이전 세션)
- 파일: `shared/macro_data/clients/political_news_client.py`
- RSS 피드 모니터링 (Reuters, BBC, NYT, WSJ, 연합뉴스)
- 키워드 기반 필터링 (fed, us_politics, trade, geopolitical, crisis)
- **용도**: 점수 계산 → 헤드라인 수집 (Council 전달용)

### 2. Council 프롬프트 확장
- 파일: `scripts/run_macro_council.py`
- `get_political_news_headlines()`: 24시간 내 정치 뉴스 최대 15개 수집
- 프롬프트에 정치/지정학적 리스크 분석 요청 추가:
  - `political_risk_level`: low, medium, high, critical
  - `political_risk_summary`: 1-2문장 요약
- `parse_council_output()`에서 새 필드 파싱

### 3. DailyMacroInsight 확장
- 파일: `shared/macro_insight/daily_insight.py`
- 새 필드:
  - `political_risk_level: str = "low"`
  - `political_risk_summary: str = ""`
- `to_dict()`, `from_dict()` 업데이트
- DB save/load 함수 업데이트

### 4. EnhancedTradingContext 업데이트
- 파일: `shared/macro_insight/trading_context.py`
- Council의 `political_risk_level` 우선 사용
- GlobalMacroSnapshot 폴백 유지

### 5. DB 마이그레이션
- 파일: `scripts/migrations/add_political_risk_to_macro_insight.sql`
- 적용 완료:
  - `POLITICAL_RISK_LEVEL` varchar(20) DEFAULT 'low'
  - `POLITICAL_RISK_SUMMARY` text
  - 인덱스: `idx_macro_insight_political_risk`

## 데이터 흐름

```
PoliticalNewsClient.fetch_alerts()
        ↓
    헤드라인 수집 (severity medium 이상, 최대 15개)
        ↓
run_macro_council.py (main)
        ↓
    Council에 뉴스 헤드라인 전달 (프롬프트 포함)
        ↓
Council (Gemini/Claude/GPT)
        ↓
    political_risk_level/summary 판단
        ↓
parse_council_output()
        ↓
DailyMacroInsight 저장 (DB + Redis)
        ↓
get_enhanced_trading_context()
        ↓
    Council political_risk 우선 사용
        ↓
Trading Services (scout-job, buy-scanner, price-monitor)
```

## 테스트 결과

- **1136 passed**, 2 skipped
- macro_insight 테스트: 38 passed
- macro_data 테스트: 83 passed (PoliticalNewsClient 15개 포함)

## 파일 변경 목록

### 신규
- `scripts/migrations/add_political_risk_to_macro_insight.sql`

### 수정
- `shared/macro_insight/daily_insight.py`
  - DailyMacroInsight 클래스에 political_risk 필드 추가
  - save_insight_to_db(), load_insight_from_db(), load_recent_insights() 업데이트
- `scripts/run_macro_council.py`
  - MACRO_ANALYSIS_QUERY 프롬프트 확장
  - get_political_news_headlines() 함수 추가
  - main()에서 정치 뉴스 수집 및 Council 전달
  - parse_council_output()에서 political_risk 파싱
  - save_macro_insight()에서 political_risk 저장
  - 출력 섹션에 Political Risk 추가
- `shared/macro_insight/trading_context.py`
  - build_trading_context()에서 Council political_risk 우선 사용
  - get_enhanced_trading_context()에서 political_risk 필드 전달
- `CLAUDE.md`
  - 세션 핸드오프 업데이트

## 다음 단계

1. **Council 분석 실행** (다음 스케줄: 07:30 KST)
   - 정치 뉴스가 Council 프롬프트에 포함됨
   - Council이 political_risk_level/summary 판단

2. **모니터링**
   - DB에서 political_risk_level 확인
   - Dashboard에서 표시 확인 (필요시 UI 추가)

3. **선택적 개선**
   - Dashboard에 Political Risk 섹션 추가
   - 알림 시스템에 critical 리스크 알림 추가

## 투자자 수급 데이터 통합 (추가 작업)

### 배경
딴지일보 글처럼 "외국인 대규모 순매도로 -5.25% 급락" 같은 수급 분석 인사이트를 원함.
pykrx에서 이미 수집하고 있었으나 GlobalMacroSnapshot → Council에 전달되지 않음.

### 완료된 작업

1. **GlobalMacroSnapshot 확장** (`shared/macro_data/models.py`)
   - `kospi_foreign_net`: KOSPI 외국인 순매수 (억원)
   - `kosdaq_foreign_net`: KOSDAQ 외국인 순매수 (억원)
   - `kospi_institutional_net`: KOSPI 기관 순매수
   - `kospi_retail_net`: KOSPI 개인 순매수
   - `to_llm_context()`에 Investor Trading 섹션 추가

2. **Aggregator 매핑 추가** (`shared/macro_data/aggregator.py`)
   - `INDICATOR_TO_SNAPSHOT`에 투자자 순매수 필드 추가
   - 메타데이터에서 기관/개인 순매수 추출

3. **Council 프롬프트 확장** (`scripts/run_macro_council.py`)
   - Investor Trading 섹션 추가
   - 수급 분석 지침 추가 (외국인 대규모 순매도 원인 분석, 반등/하락 시나리오)

4. **pykrx 1.2.x 호환성 수정** (`shared/macro_data/clients/pykrx_client.py`)
   - pykrx 1.0.51 → 1.2.3 업그레이드
   - `get_index_trading_value_by_investor` → `get_market_trading_value_by_investor`
   - 응답 형식 변경 대응: 인덱스=투자자유형, 컬럼='순매수'
   - 파라미터 수정: 지수코드("1001") → 시장명("KOSPI")

### 테스트 결과 (2024-12-20)
```
[KOSPI 투자자 순매수]
  외국인: -8,181억 (대규모 순매도)
  개인: +7,890억 (외국인 매도 받아냄)
  연기금: +1,870억
  기관합계: -883억
```

### Council 프롬프트 예시
```
### Investor Trading (투자자별 순매수, 억원)
- KOSPI 외국인: -8,181억
- KOSDAQ 외국인: -1,234억
- KOSPI 기관: -883억
- KOSPI 개인: +7,890억

### 수급 분석 (Investor Flow)
- 외국인 대규모 순매도 시: 원인 분석 (글로벌 리스크오프? 환율? 특정 이벤트?)
- 수급 불균형이 있다면 반등/추가하락 시나리오 제시
```

### Git Commits
1. `6a55c35` - feat(macro): Integrate political news into Council LLM analysis
2. `631132c` - feat(macro): Add investor trading data to Council analysis
3. `21aac08` - fix(pykrx): Update to pykrx 1.2.x API format

## 관련 세션

- 이전: 정치 뉴스 키워드 모니터링 시스템 구현 (PoliticalNewsClient)
- 이전: Council 트레이딩 추천 기능 구현
- 이전: Enhanced Macro → Trading Services 통합
