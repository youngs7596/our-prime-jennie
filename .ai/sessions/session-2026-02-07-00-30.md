# Session Handoff: Factor Alpha Study & Smart Money 5D 최적화

**일시**: 2026-02-07 00:30 KST
**브랜치**: development
**이전 커밋**: `88a4b5c`

## 작업 요약 (What was done)

### 1. Factor Alpha Study 기반 Smart Money 5D 팩터 통합

`scripts/factor_alpha_study.py`에서 발견한 강력한 팩터(smart_money_5d, IR=4.1)를
scout의 quant_scorer에 통합하는 작업을 수행.

#### 초기 구현 (25점 가중치)
- `calculate_supply_demand_score()`: 15점 → 25점으로 확대, smart_money_5d 12점 신규 배정
- `calculate_total_quant_score()`: 모멘텀 25→20점, 가치 15→10점으로 축소
- `quant_constants.py`: supply_demand 가중치 강화 (단기 0.20→0.30, 장기 0.10→0.18)
- `scout_pipeline.py`: `get_investor_trading()` DB 조회 → `investor_trading_df` 전달

#### 백테스트 검증 → 15점 기본 + 보너스 방식으로 최적화
- **가중치 배분 백테스트** (`scripts/backtest_weight_allocation.py`):
  - 4개 시나리오: A(15점), B(25점), C(20점), D(18점)
  - **결과: 기존 15점이 모든 기간에서 최고 성과** (D+5: +1.12%, D+20: +4.06%)
  - 25점은 D+20에서 -3.85% → smart_money_5d 중립값이 유효 팩터를 희석

- **윈도우 비교** (`scripts/smart_money_window_compare.py`):
  - foreign_flow_10d (IR=1.445) >> smart_money_5d (IR=0.120)
  - 기관 합산이 오히려 노이즈를 추가

- **"이미 오른 건 아닌가?" 분석**:
  - 외인 5D 상위 분위: 과거 5일간 겨우 +0.08% → 래깅 지표 가설 반증
  - 즉, 신호 자체는 유효하지만 전체 가중치에 녹이면 희석됨

#### 최종 구현: 15점 기본 + 조건부 보너스 (최대 3점)
- `calculate_supply_demand_score()`: 원래 15점 구조 복원 (7+5+3)
- smart_money_5d는 sm_ratio > 2% 일 때만 보너스 +0~3점
- 모멘텀/가치 점수 원래대로 복원 (25점/15점)
- `quant_constants.py` 가중치 완전 원복
- Dual Track 비율 원복 (20/15, 10/15)
- `investor_trading_df` 파이프라인은 유지 (보너스 계산에 필요)

### 2. 백테스트 스크립트 작성 (6개)
- `scripts/factor_alpha_study.py`: 17개 팩터 IC/IR/승률 분석
- `scripts/analyze_winners.py`: 20%+ 상승 종목 식별
- `scripts/analyze_winners_step2.py`: 승자 종목 패턴 분석
- `scripts/backtest_smart_money.py`: Smart Money 5D 효과 검증
- `scripts/backtest_weight_allocation.py`: 가중치 배분 최적화
- `scripts/smart_money_window_compare.py`: 3/5/10일 윈도우 비교

### 3. 테스트 보강
- `test_quant_scorer.py`: 13개 테스트 추가 (TestSupplyDemandScore 8개, TestQuantConstantsWeights 3개, TestTotalScoreWithInvestorTrading 3개)
- 전체 테스트: **1013 passed**, 1 skipped

## 변경 파일

### Production 코드
| 파일 | 변경 내용 |
|------|-----------|
| `shared/hybrid_scoring/quant_scorer.py` | supply_demand에 `investor_trading_df` 파라미터 추가, smart_money_5d 조건부 보너스, 중복 dip-bonus 제거 |
| `services/scout-job/scout_pipeline.py` | `get_investor_trading()` DB 조회 추가 |

### 테스트
| 파일 | 변경 내용 |
|------|-----------|
| `tests/shared/hybrid_scoring/test_quant_scorer.py` | 13개 테스트 추가 (supply_demand, constants, investor_trading) |

### 분석 스크립트 (untracked)
- `scripts/factor_alpha_study.py`
- `scripts/analyze_winners.py`, `scripts/analyze_winners_step2.py`
- `scripts/backtest_smart_money.py`, `scripts/backtest_weight_allocation.py`
- `scripts/smart_money_window_compare.py`

## 핵심 학습 (Key Learnings)

1. **팩터 IR이 높다고 가중치를 높이면 안 됨**: smart_money_5d의 IR=4.1이지만, 중립값(데이터 없는 종목 대부분)이 다른 유효 팩터를 희석
2. **보너스 방식이 최적**: 기존 가중치 유지 + 강한 신호일 때만 보너스 → 기본 성과 보존 + 알파 포착
3. **기관 합산은 노이즈**: foreign_flow_10d (IR=1.445) >> smart_money_5d (IR=0.120)
4. **지속 매수 ≠ 이미 오른 것**: 외인 5D 상위 분위 과거 수익률 +0.08%에 불과

## 후속 과제 (Optional)

- [ ] 뉴스 역신호 패널티 재검토 (배당 D+5 승률 37.6% → -3점 cap 적정한지)
- [ ] KOSDAQ 유동성 가중치 구분 (현재 KOSPI/KOSDAQ 동일 기준)
- [ ] 실 운영 데이터 축적 후 scout 추천 vs 실제 수익률 추적 시스템

## 시스템 상태

- **Scout**: smart_money_5d 보너스 통합 완료, 기존 가중치 최적 유지
- **테스트**: 1013 passed, 1 skipped
- **브랜치**: development (origin보다 1커밋 ahead + uncommitted changes)
