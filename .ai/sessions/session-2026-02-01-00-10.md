# Session Handoff: DB 인덱스 & 시스템 최적화

**Date**: 2026-02-01 00:10 KST
**Branch**: `development`
**Last Commit**: `faf55a7 docs: Add session handoff for dashboard redesign`

---

## Summary

MariaDB 인덱스 생성, 프론트엔드 번들 최적화, Redis 패턴 개선, 데이터 보관 정책 수립 등 전반적인 시스템 최적화 작업 수행.

---

## Completed Work

### 1. MariaDB 인덱스 생성 (54개)

**Script**: `scripts/migrate_create_indexes.py`

주요 인덱스:
| 테이블 | 레코드 수 | 인덱스 |
|--------|----------|--------|
| NEWS_SENTIMENT | 55만 | stock_code, published_at, created_at |
| STOCK_NEWS_SENTIMENT | 52만 | stock_code, news_date, 복합(stock_code+news_date) |
| STOCK_DAILY_PRICES_3Y | 50만 | price_date |
| BACKTEST_TRADELOG | 45만 | trade_date, stock_code |
| STOCK_MINUTE_PRICE | 34만 | stock_code |
| TRADELOG | 238 | trade_timestamp, stock_code, 복합 |

---

### 2. Frontend 번들 최적화

**Files**:
- `services/dashboard/frontend/vite.config.ts` - rollupOptions 추가
- `services/dashboard/frontend/src/App.tsx` - lazy loading

**변경 내용**:
- 페이지별 코드 스플리팅 (React.lazy)
- 벤더 청크 분리: vendor-react, vendor-charts, vendor-radix, vendor-state, vendor-motion
- 결과: 단일 1MB+ 번들 → 여러 작은 청크로 분리

---

### 3. bare except 블록 수정 (10+ 파일)

**수정된 파일**:
- `services/dashboard/backend/routers/system.py`
- `services/buy-scanner/main.py`
- `services/daily-briefing/reporter.py`
- `shared/kis/request.py`
- `shared/database/market.py`
- `shared/financial_data_collector.py`
- `shared/llm_providers.py`
- `shared/hybrid_scoring/quant_scorer.py`

**Before**: `except:` (모든 예외 무시)
**After**: `except (SpecificError, ...)` (구체적 예외 타입)

---

### 4. Redis KEYS → SCAN 패턴 변경

**Files**:
- `services/dashboard/backend/main.py:475` - sentiment API
- `shared/redis_cache.py:475` - competitor benefit 조회

**Before**:
```python
keys = r.keys("sentiment:*")  # O(N) 블로킹
for key in keys:
    data = r.get(key)  # N+1 요청
```

**After**:
```python
keys = list(r.scan_iter(match="sentiment:*", count=100))  # 비블로킹
values = r.mget(keys)  # 1회 요청
```

---

### 5. 데이터 보관 정책 및 Cleanup DAG

**Script**: `scripts/cleanup_old_data.py`
**DAG**: `dags/utility_jobs_dag.py` - `data_cleanup_weekly`

**보관 정책** (모든 테이블 1년):
- NEWS_SENTIMENT, STOCK_NEWS_SENTIMENT
- STOCK_MINUTE_PRICE, MARKET_FLOW_SNAPSHOT
- SHADOW_RADAR_LOG, LLM_DECISION_LEDGER
- COMPETITOR_BENEFIT_EVENTS

**영구 보관 (정리 안 함)**:
- STOCK_DAILY_PRICES_3Y, BACKTEST_TRADELOG, TRADELOG
- WATCHLIST_HISTORY, DAILY_ASSET_SNAPSHOT, FINANCIAL_DATA

**스케줄**: 매주 일요일 03:00 KST

---

### 6. SQLAlchemy 2.0 API 표준화

**File**: `shared/db/repository.py`

**Before** (Legacy 1.x API):
```python
config = session.query(models.Config).filter(...).first()
```

**After** (2.0 API):
```python
stmt = select(models.Config).where(...)
config = session.scalars(stmt).first()
```

---

### 7. macro-aggregator 의존성 수정

**File**: `services/macro-aggregator/requirements.txt`

**추가된 패키지**:
- sqlalchemy>=2.0.0
- mysql-connector-python>=8.0.0
- pandas
- pytz
- requests

---

## Files Changed

```
services/dashboard/frontend/
├── vite.config.ts              # 번들 최적화
└── src/App.tsx                 # lazy loading

services/dashboard/backend/
├── main.py                     # Redis SCAN 패턴
└── routers/system.py           # bare except 수정

services/buy-scanner/main.py
services/daily-briefing/reporter.py
services/macro-aggregator/requirements.txt  # 의존성 추가

shared/
├── db/repository.py            # SQLAlchemy 2.0
├── redis_cache.py              # Redis SCAN 패턴
├── kis/request.py
├── llm_providers.py
├── database/market.py
├── financial_data_collector.py
└── hybrid_scoring/quant_scorer.py

scripts/
├── migrate_create_indexes.py   # NEW - 인덱스 마이그레이션
└── cleanup_old_data.py         # NEW - 데이터 정리

dags/utility_jobs_dag.py        # cleanup DAG 추가
```

---

## Current State

- **빌드**: 성공 ✅
- **테스트**: 미실행
- **인덱스**: 54개 생성 완료 ✅
- **컨테이너**: macro-aggregator 정상 작동 ✅

---

## TODO / Next Steps

1. **커밋 필요**: 이번 세션 변경사항 커밋
2. **SQLAlchemy 2.0 마이그레이션 확장**: 12개 파일에 레거시 `.query()` 패턴 남아있음
   - shared/database/market.py
   - shared/analysis/performance_calculator.py
   - shared/database/trading.py
   - shared/db/factor_repository.py
   - 등등
3. **테스트 커버리지 확대**: buy-executor, price-monitor 등

---

## Commands for Next Session

```bash
# 변경사항 커밋
git add -A && git commit -m "perf: DB indexes, bundle optimization, Redis patterns"

# 인덱스 상태 확인
python scripts/migrate_create_indexes.py --check-only

# 데이터 정리 dry-run
python scripts/cleanup_old_data.py --dry-run

# 프론트엔드 빌드
cd services/dashboard/frontend && npm run build
```

---

*Last Updated: 2026-02-01 00:10 KST*
