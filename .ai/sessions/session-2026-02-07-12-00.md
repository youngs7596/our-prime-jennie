# Session 2026-02-07 12:00 - Factor Alpha P0+P1+P2 구현 & 백테스트 검증

## 배경
Grid Backtest 216조합 분석 결과와 Factor Alpha Study를 기반으로 Quant Scorer 및 LLM 스코어링 파이프라인에 3단계(P0+P1+P2) 패치를 적용. 4주 백테스트로 효과 검증.

## 변경 사항

### P0: 데이터 품질 (collect_full_market_data_parallel.py)
- 주말/공휴일 데이터 필터링 추가 (DB 삽입 전)
- 잘못된 날짜 데이터가 팩터 계산을 왜곡하는 문제 방지

### P1: Quant Scorer 패치 (quant_scorer.py)
1. **P1-2 Recon Protection 강화**: RSI 보호 해제 범위 50-70 → 50-59, 1M 모멘텀 > 0 필수
2. **P1-3 고점+과열 감점**: DD>-3% & RSI>70 → -1.5점, DD>-2% & RSI>65 → -1.0점
3. **P1-4 수급 추세 반전**: 외인 매도 전환 -2점, 매수 전환 +1.5점

### P2: LLM 스코어링 구조 개선
1. **P2-1 LLM Calibrator 확장** (llm_constants.py, llm_prompts.py)
   - Hunter/Judge 점수 조정 범위 ±15/20 → ±30
   - `risk_tag` 출력 추가 (BULLISH/NEUTRAL/CAUTION/DISTRIBUTION_RISK)
2. **P2-1 Veto Power** (scout_pipeline.py)
   - DISTRIBUTION_RISK → is_tradable=False, trade_tier=BLOCKED
3. **P2-2 Safety Lock 비대칭** (scout_pipeline.py)
   - LLM 과낙관 (Quant < LLM, diff≥30): Q:75 L:25 (기존 유지)
   - LLM 경고 (LLM < Quant, diff≥30): Q:40 L:60 (기존 45:55)
   - LLM < 40 명시 경고: Q:45 L:55 (신규)

### 메타데이터 저장 활성화 (database/trading.py)
- `save_to_watchlist_history`에 `[LLM_METADATA]{json}` 마커 임베딩 추가
- 기존 `save_to_watchlist` (현재 테이블)에만 저장되던 메타데이터를 히스토리에도 저장
- 향후 백테스트 재현성 확보

### 백테스트 스크립트 (신규)
- `scripts/backtest_grid.py`: 216조합 그리드 탐색 (Phase 1: 전종목 2개월, Phase 2: Watchlist 4주)
- `scripts/backtest_p1p2_validation.py`: P1+P2 패치 효과 검증 (4주 watchlist 데이터)
- `scripts/dryrun_p1_patches.py`: P1 패치 드라이런 (기존 점수 vs 패치 점수 비교)
- `scripts/recollect_prices_fdr.py`: FDR 가격 데이터 재수집 유틸리티

### 백테스트 분석 문서
- `docs/backtest-analysis-2026-02-07.md`: Grid 분석 결과 + P0~P2 구현 상세

## 핵심 백테스트 결과

### Grid Backtest (216조합)
- 최적 프로필: QUALITY_VALUE (quality30/value25), IR=0.797
- 단, out-of-sample 미검증 → 적용 보류

### P1+P2 검증 백테스트 (4주 Watchlist)
| 지표 | Stored Hybrid | Quant Base | Quant Patched |
|------|--------------|-----------|--------------|
| IC | -0.1523 | +0.0285 | +0.0317 |
| Q5-Q1 Spread | -4.61%p | -0.58%p | 개선 |

- **핵심 발견**: LLM이 IC를 -0.18 악화시키고 있었음 (gpt-oss:20b 기반)
- DeepSeek V3.2 클라우드 전환 + P2 구조 개선으로 개선 기대

## 주요 발견 & 인사이트
- 모멘텀 다이버전스(6M↑+1M↓)는 감점이 아니라 **눌림목 매수 시그널** (D+5 +2.38%)
- RSI 60+ 보호 해제는 hit rate 47%로 비효과적 → 50-59로 축소
- 고점+과열 감점: 단순 DD 감점은 mean reversion 역효과 → DD+RSI 복합 조건 필요
- LLM IC 역상관: watchlist LLM 80+ → D+5 -0.09%, 60- → +11%

## 수정 파일
- `scripts/collect_full_market_data_parallel.py` (P0: 주말/공휴일 필터)
- `shared/hybrid_scoring/quant_scorer.py` (P1: Recon/고점/수급 패치)
- `shared/llm_constants.py` (P2: risk_tag 스키마)
- `shared/llm_prompts.py` (P2: ±30 범위 + risk_tag)
- `services/scout-job/scout_pipeline.py` (P2: Veto + Safety Lock)
- `shared/database/trading.py` (메타데이터 저장)
- `docs/backtest-analysis-2026-02-07.md` (분석 문서)
- `scripts/backtest_grid.py` (신규)
- `scripts/backtest_p1p2_validation.py` (신규)
- `scripts/dryrun_p1_patches.py` (신규)
- `scripts/recollect_prices_fdr.py` (신규)

## 테스트 결과
- Hybrid scoring 테스트: 128 passed
- Scout-job 테스트: 10 passed
- LLM 테스트: 114 passed
- 전체: 252 passed, 0 failed

## HOLD 사항
- QUALITY_VALUE 가중치 전환: rolling window out-of-sample 검증 필요
- LLM 성능 모니터링: DeepSeek V3.2 전환 후 2주간 IC 추이 관찰 필요

## 시스템 상태
- 모든 서비스 정상 가동
- DeepSeek V3.2 Cloud API 활성 (CloudFailoverProvider)
- vLLM (EXAONE 4.0 + KURE-v1) 정상
