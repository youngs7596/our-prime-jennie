# Session Handoff: 2026-02-11 20:30 KST

## 주제: LLM 사용 통계 서비스별 정확한 기록

### 문제
Dashboard Home의 "LLM 사용 통계" 카드에서 **Scout(Unified Analyst)**, **Briefing**, **Macro Council** 호출 횟수/토큰이 항상 0으로 표시됨.

**원인**:
- `_record_llm_usage()`가 `OpenAILLMProvider`에만 존재
- 서비스 키가 `"news_analysis"`로 하드코딩
- Scout → `CloudFailoverProvider` → 내부 `OpenAILLMProvider` → `"news_analysis"`로 잘못 기록
- Briefing → `ClaudeLLMProvider` → 기록 메서드 자체 없음 (0)
- Macro Council → 마찬가지로 0

### 변경 사항

| 파일 | 변경 내용 |
|------|----------|
| `shared/llm_providers.py` | `_record_llm_usage()` BaseLLMProvider로 승격, 모든 provider에 `service` 파라미터 추가 |
| `shared/llm.py` | `run_analyst_scoring()` → `service="scout"`, `generate_daily_briefing()` → `service="briefing"` |
| `scripts/run_macro_council.py` | 전략가/리스크분석가/수석심판 4곳 → `service="macro_council"` |
| `services/dashboard/backend/routers/llm.py` | `macro_council` 키 추가 (모델 + target_keys + 응답) |
| `tests/shared/test_llm_providers.py` | 12개 새 테스트 (UsageRecording 전체 커버) |

### 기술 상세

#### Provider별 변경
- **BaseLLMProvider**: `_record_llm_usage(service, tokens_in, tokens_out, model)` 공통 메서드
- **OpenAILLMProvider**: `"news_analysis"` 하드코딩 제거 → `service or "unknown"`
- **ClaudeLLMProvider**: `generate_json`, `generate_chat`, `generate_json_with_thinking` 모두 `service` 지정 시 `response.usage.input_tokens/output_tokens` 기록
- **CloudFailoverProvider**: `generate_json/chat`에서 `service` kwarg를 `_failover_call`을 통해 inner provider에 투명 전달
- **OllamaLLMProvider, GeminiLLMProvider**: 시그니처만 추가 (로컬 무료/미사용)

#### Redis 키 구조
```
llm:stats:{YYYY-MM-DD}:{service}  →  {calls, tokens_in, tokens_out}
```
서비스 키: `scout`, `briefing`, `macro_council`, `news_analysis`(레거시), `unknown`(미지정)

### 테스트 결과
- `test_llm_providers.py`: 32 passed (기존 20 + 신규 12)
- `tests/shared/`: 1160 passed
- `tests/scripts/test_macro_council_pipeline.py`: 31 passed
- `tests/services/buy-executor/`: 26 passed

### 커밋
- `5c41f27` feat(llm): 서비스별 LLM 사용 통계 정확 기록 — _record_llm_usage BaseLLMProvider 승격

### 시스템 상태
- 기존 모든 기능 정상 (하위 호환 유지, `service=None` 시 기존 동작)
- Dashboard에서 Scout/Briefing/Macro Council 통계가 다음 실행부터 자동 표시
- Frontend 변경 불필요 (이미 `llmStats.scout?.calls` 등 읽고 있음)
