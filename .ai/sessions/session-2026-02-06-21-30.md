# Session Handoff: RAG 검색 품질 개선 & Jenkins 파이프라인 단순화

**일시**: 2026-02-06 21:30 KST
**브랜치**: development
**커밋 범위**: `8d4d34d..ab2b2f0` (6개 커밋)

## 작업 요약 (What was done)

### 1. RAG 검색 품질 개선 (Council 승인 후 구현)
Prime Council 3현자 리뷰($0.21) 후 3개 Phase 즉시 구현:

- **Phase 2: 다중 쿼리 검색 전략** (`scout.py`)
  - 하드코딩 단일 쿼리 → `_generate_news_search_queries()` (실적/수주/리스크 + 섹터별)
  - `fetch_stock_news_from_chroma()`: 쿼리당 k=3, 결과 병합 + 중복 제거

- **Phase 1C: page_content 메타데이터 강화**
  - Naver: `"뉴스 제목: ...\n링크: ..."` → `"[종목명(코드)] 제목 | 출처: Naver Finance | 날짜: ..."`
  - RSS: `"뉴스 제목: ...\n링크: ..."` → `"[시장뉴스] 제목 | 출처: ... | 날짜: ..."`
  - analyzer.py: `_extract_news_title()` 헬퍼 추가 (신규/레거시 포맷 모두 지원)

- **Phase 3: RAG 후보 발굴 개선** (`scout.py`)
  - 4개 테마별 쿼리 (실적 개선, 수주/계약, 신사업/M&A, 주주환원)
  - 7일 이내 `created_at_utc` 필터 + `rag_seen_codes` 중복 제거

### 2. Qdrant 필터 버그 수정 (중요!)
- **문제**: `langchain-qdrant 1.1.0`이 MongoDB 스타일 dict 필터 미지원 → RAG 검색 항상 0건
- **해결**: `models.Filter` + `FieldCondition` 네이티브 필터로 교체
- **효과**: RAG 후보 0개 → **35개** 발굴

### 3. Jenkins 파이프라인 대폭 단순화
Smart Build(`smart_build.py`) 의존성 완전 제거:

| Before (54줄) | After (17줄) |
|---------------|-------------|
| python3 + git 설치 | git만 설치 |
| `.last_successful_build` 커밋 추적 | 불필요 |
| `smart_build.py --action build` (변경 감지) | 불필요 |
| `smart_build.py --action deploy --no-build` | `docker compose up -d --build` |

**핵심**: BuildKit 레이어 캐시가 변경 감지를 네이티브로 처리
- 변경 없는 서비스: 캐시 히트 → 이미지 동일 → 컨테이너 유지
- 변경된 서비스: 해당 레이어만 재빌드 → 컨테이너 재생성
- 빌드 시간: ~5분 (전체 17서비스, 캐시 포함)

### 4. Jenkins CI 버그 수정 (이전 세션에서 이어짐)
- `docker:dind` → `docker:cli` (ENTRYPOINT 오류)
- Smart Build 재시도 시 변경 감지 실패 → `.last_successful_build` 메커니즘
- Bootstrap 시 전체 빌드 트리거
- ollama-gateway 테스트 4건 수정

## 커밋 이력

| 커밋 | 설명 |
|------|------|
| `8d4d34d` | RAG 검색 품질 개선: 다중 쿼리 + page_content 강화 + 후보 발굴 |
| `38ca231` | ollama-gateway vLLM 테스트 4건 수정 |
| `f8af348` | Smart Build 재시도 변경 감지 수정 |
| `fd36bc8` | docker:dind → docker:cli |
| `9c3a7ea` | Smart Build bootstrap 전체 빌드 트리거 |
| `83c25c9` | Jenkins 파이프라인 대폭 단순화 (BuildKit 위임) |
| `ab2b2f0` | Qdrant 필터 네이티브 models.Filter 교체 |

## 검증 결과

### Scout 실행 비교
| 항목 | Before (필터 버그) | After (수정 후) |
|------|-------------------|----------------|
| RAG 후보 발굴 | 0개 | **35개** |
| ChromaDB 뉴스 | 162/194 (45.6초) | 168/194 (28.8초) |
| 최종 Watchlist | 15개 | 15개 |
| 총 소요시간 | 541초 | **417초** (-23%) |

### Jenkins 빌드
- Build #311: 5분 3초 (SUCCESS) — 단순화된 파이프라인 첫 실행
- Build #312: SUCCESS — Qdrant 필터 수정 반영

### 테스트
- 1179 passed, 1 skipped

## 변경 파일

| 파일 | 변경 |
|------|------|
| `services/scout-job/scout.py` | 다중 쿼리, RAG 후보 발굴, Qdrant 네이티브 필터 |
| `shared/crawlers/naver.py` | page_content 메타데이터 강화 |
| `services/news-collector/collector.py` | RSS page_content 강화 |
| `services/news-analyzer/analyzer.py` | `_extract_news_title()` 헬퍼 |
| `scripts/backfill_news_naver.py` | 신규/레거시 포맷 호환 |
| `Jenkinsfile` | Smart Build → `docker compose up -d --build` |
| `tests/services/ollama-gateway/test_vllm_backend.py` | 테스트 4건 수정 |

## 현재 상태

- **Scout**: RAG 다중 쿼리 + Qdrant 필터 정상 동작 (35개 후보 발굴)
- **Jenkins**: BuildKit 캐시 기반 단순 파이프라인 (17줄)
- **Qdrant**: 6607 포인트, 5103건 7일 이내 데이터
- **Working tree**: clean
- **테스트**: 1179 passed

## 다음 할 일 (Next Steps)

- [ ] 장중 Scout 실행 결과 확인 (RAG 후보가 실제 Watchlist에 미치는 영향)
- [ ] 기존 Qdrant 데이터 page_content가 레거시 포맷 — archiver가 새 뉴스부터 신규 포맷 저장
- [ ] `smart_build.py` 정리 여부 결정 (현재 Jenkins에서 미사용, 수동 유틸로 잔존)
- [ ] CLAUDE.md 업데이트 (Jenkins 파이프라인 섹션)

## 핵심 교훈

1. **langchain-qdrant 필터 호환성**: v1.1.0은 MongoDB 스타일 dict 필터 미지원. 반드시 `qdrant_client.http.models.Filter` 사용
2. **BuildKit > Smart Build**: Docker BuildKit 레이어 캐시가 git diff 기반 변경 감지보다 정확하고 단순
3. **Council 리뷰 효과**: $0.21로 3현자 코드 리뷰 → 구현 방향 사전 검증
