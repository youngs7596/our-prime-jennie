# Session Handoff: DeepSeek V3.2 Cloud Failover & Scout 비용 최적화

**일시**: 2026-02-06 14:48 KST
**브랜치**: development

## 요약 (Summary)
DeepSeek V3.2 3-Tier Cloud Failover를 구현하여 Ollama Cloud 503 에러 문제를 해결하고,
비용 우선 순서(DeepSeek API → OpenRouter → Ollama Cloud)로 최적화했다.
로컬 LLM fallback(`gpt-oss:20b`)을 제거하고 RTX 3090은 vLLM(exaone+kure) 전용으로 유지.
Scout job 스케줄을 30분→1시간으로 변경하여 월 LLM 비용을 ~$17로 절감.

## 변경 사항 (Changes)

### CloudFailoverProvider 구현
- `shared/llm_providers.py`: `CloudFailoverProvider` 클래스 추가 (~110줄)
  - Failover 체인: DeepSeek API → OpenRouter → Ollama Cloud
  - API 키 없는 프로바이더 자동 건너뜀
  - `_failover_call()`: 순차 시도, 실패 시 로깅 후 다음 프로바이더
- `shared/llm_factory.py`: `deepseek_cloud` provider type 등록
- `shared/auth.py`: `openrouter-api-key`, `deepseek-api-key` env 매핑 추가

### 로컬 fallback 제거
- `shared/llm_providers.py`: Cloud 실패 시 `gpt-oss:20b` fallback → `raise`
- `services/ollama-gateway/main.py`: Cloud proxy `gpt-oss:20b` fallback → `raise`

### Retry/대기시간 축소 (3-tier failover이므로 개별 retry 최소화)
- Ollama Cloud retry: 5회/3s base → 2회/1s base
- OllamaProvider max_retries: 3 → 2
- generate_json/chat 내부 retry: 3 → 2

### Docker/환경변수
- `docker-compose.yml`: scout-job/worker `TIER_*_PROVIDER=deepseek_cloud`, `LOCAL_MODEL_*` 라인 제거
- `infrastructure/env-vars-wsl.yaml`: REASONING/THINKING 기본값 `deepseek_cloud`, `LOCAL_MODEL_*` 제거

### Scout 스케줄 최적화
- `dags/scout_job_dag.py`: `0,30 8-15` → `30 8-15` (30분→1시간 간격, 15→8회/일)

### 테스트
- `tests/shared/test_cloud_failover_provider.py`: 10개 테스트 신규 작성
- `tests/shared/test_llm_providers.py`: `max_retries` assertion 업데이트

## 검증 결과
- PoC (`scripts/poc_cloud_failover.py`): 3개 프로바이더 모두 API 호출 성공
  - DeepSeek API: 3.4s (가장 빠름, 가장 저렴)
  - OpenRouter: 13.1s
  - Ollama Cloud: 12.0s
- 실배포 테스트: Scout worker에서 DeepSeek API 1차 시도 성공, 종목당 0.1~0.3초
- 테스트: 999 passed, 1 skipped (shared 전체), 47 passed (LLM 관련)

## 비용 분석
- 1회 실행: 108 requests, 220K tokens → ~$0.096 (~140원)
- 월간 (1시간 간격, 8회/일, 22영업일): ~$16.9 (~24,500원)

## 다음 단계 (Next Steps)
- [ ] CloudFailoverProvider 인스턴스 캐싱 검토 (매 LLM 호출마다 new 생성 중)
- [ ] DeepSeek API rate limit 모니터링 (대량 동시 호출 시 429 가능성)
- [ ] OpenRouter 크레딧 소진 시 체인에서 제거 여부 결정

## Context for Next Session
- `shared/llm_providers.py`: CloudFailoverProvider 클래스 (line 957~)
- `shared/llm_factory.py`: deepseek_cloud 분기 (line 147~)
- `dags/scout_job_dag.py`: 스케줄 변경
- `docker-compose.yml`: scout-job/worker 환경변수 (line 694~, 735~)
