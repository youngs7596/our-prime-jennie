# Session Handoff: 2026-02-12 23:00

## 세션 주제
인프라 단순화: RabbitMQ 제거 (→ Redis Streams) + Ollama Gateway 제거 (→ vLLM 직접 호출)

## 배경
- **RabbitMQ**: 3개 큐(buy-signals, sell-orders, jobs.scout)만 사용, 고급 기능 미사용 → 이미 있는 Redis Streams로 대체 가능
- **Ollama Gateway**: vLLM 전환 완료 후 API 포맷 변환만 수행하는 프록시 → OllamaLLMProvider 직접 vLLM 호출로 불필요
- 인프라 서비스 2개 제거로 메모리/복잡도 절감

## 변경 내역

### Part 1: RabbitMQ → Redis Streams

#### 신규 모듈: `shared/messaging/trading_signals.py`
- **TradingSignalPublisher**: `publish(payload)` → XADD, `close()`
- **TradingSignalWorker**: `start()` → XREADGROUP 데몬 쓰레드, `stop()` → graceful shutdown
- Stream 상수: `STREAM_BUY_SIGNALS`, `STREAM_SELL_ORDERS`, `STREAM_JOBS_SCOUT`, `STREAM_JOBS_PREFIX`
- Group 상수: `GROUP_BUY_EXECUTOR`, `GROUP_SELL_EXECUTOR`, `GROUP_SCOUT_WORKER`
- ACK 전략: handler 호출 전 ACK (기존 RabbitMQ at-most-once 시맨틱 유지)
- pending 자동 복구: 시작 시 `_recover_pending()` 호출

#### 서비스 전환 (7개)
| 서비스 | 변경 |
|--------|------|
| buy-scanner | RabbitMQPublisher → TradingSignalPublisher(STREAM_BUY_SIGNALS) |
| buy-executor | RabbitMQWorker → TradingSignalWorker(STREAM_BUY_SIGNALS, GROUP_BUY_EXECUTOR) |
| sell-executor | RabbitMQWorker → TradingSignalWorker(STREAM_SELL_ORDERS, GROUP_SELL_EXECUTOR) |
| price-monitor | RabbitMQPublisher → TradingSignalPublisher(STREAM_SELL_ORDERS) |
| command-handler | RabbitMQPublisher x2 → TradingSignalPublisher x2 |
| scout-job | RabbitMQPublisher+Worker → TradingSignalPublisher+Worker(STREAM_JOBS_SCOUT) |
| scheduler-service | RabbitMQPublisher+Worker → TradingSignalPublisher+Worker(STREAM_JOBS_PREFIX) |

#### 삭제
- `shared/rabbitmq.py` (전체)
- 11개 requirements.txt에서 `pika` 삭제
- docker-compose.yml: rabbitmq 서비스 정의, 모든 RABBITMQ_* env var, depends_on: rabbitmq 삭제
- `tests/inject_buy_signal_mq.py`, `tests/inject_sell_signal_mq.py`, `tests/check_mq_queue.py`, `manual_buy_trigger.py` 삭제

### Part 2: Ollama Gateway 제거

#### OllamaLLMProvider 직접 vLLM 호출 (`shared/llm_providers.py`)
- **VLLM_MODEL_MAP**: Ollama 모델명 → vLLM 모델명 (e.g., `exaone3.5:7.8b` → `LGAI-EXAONE/EXAONE-4.0-32B-AWQ`)
- **`_clamp_max_tokens()`**: 한국어 ~2 char/token 기반 토큰 클램핑 (Gateway에서 이전)
- **`_call_vllm_direct()`**: Ollama `/api/generate` 형식 → OpenAI `/v1/chat/completions` 변환
- **삭제**: `use_gateway`, `gateway_url`, `_call_via_gateway()`, `self.use_gateway` 참조

#### news-archiver + scout-job 임베딩 전환
- `langchain-ollama OllamaEmbeddings` → `langchain-openai OpenAIEmbeddings`
- `OLLAMA_GATEWAY_URL` → `VLLM_EMBED_URL` (default: `http://localhost:8002/v1`)

#### 삭제
- `services/ollama-gateway/` (전체 디렉토리)
- `tests/services/ollama-gateway/` (전체 디렉토리)
- docker-compose.yml: ollama-gateway 서비스, USE_OLLAMA_GATEWAY, OLLAMA_GATEWAY_URL 삭제

### Part 3: 테스트/참조 정리
- `test_llm_providers.py`: mock 응답 Ollama → OpenAI 형식, gateway 테스트 삭제
- `test_scheduler.py`: `shared.rabbitmq` patch → `shared.messaging.trading_signals` patch
- `test_scheduler_integration.py`: mock_rabbitmq → mock_signal_publisher
- `test_buy_executor.py`: `source='rabbitmq'` → `source='stream'`
- `diagnosis.py`: `RABBITMQ_URL` fallback 제거 → `REDIS_URL` 직접 사용
- `registry.py`: RABBITMQ_PASS, RABBITMQ_USER 설정 항목 삭제
- `system.py`: `/rabbitmq` 엔드포인트 → 빈 응답 반환 (프론트 호환)
- `smart_build.py`: ollama-gateway 서비스 매핑/배포 순서 삭제
- `env-vars-mock.yaml`: RABBITMQ_* 환경변수 삭제
- utility 스크립트: OLLAMA_GATEWAY_URL → VLLM_LLM_URL 전환

### Docker 정리
- `docker system prune -a --volumes`: 309GB 회수 (193→52GB 이미지, 168→0GB 빌드 캐시)

## 수정 파일 목록

### 신규 (1개)
- `shared/messaging/trading_signals.py`

### 수정 (약 40개)
- `shared/llm_providers.py`, `shared/diagnosis.py`, `shared/settings/registry.py`
- `services/buy-scanner/main.py`, `opportunity_watcher.py`
- `services/buy-executor/main.py`, `executor.py`
- `services/sell-executor/main.py`
- `services/price-monitor/main.py`
- `services/command-handler/main.py`, `handler.py`, `handler_trading.py`
- `services/scout-job/main.py`, `scout.py`
- `services/scheduler-service/main.py`, `worker.py`
- `services/news-archiver/archiver.py`, `requirements.txt`
- `services/dashboard/backend/routers/system.py`
- `docker-compose.yml`, `infrastructure/env-vars-wsl.yaml`, `infrastructure/env-vars-mock.yaml`
- 11개 `requirements.txt` (pika 삭제)
- `scripts/smart_build.py`, `benchmark_llm.py`, `test_airflow_connectivity.py`, `systemd_autostart.sh`
- `utilities/backfill_scout_real.py`, `backfill_watchlist_history_llm.py`
- 테스트 파일 6개

### 삭제 (10개)
- `shared/rabbitmq.py`
- `services/ollama-gateway/` (Dockerfile, main.py, requirements.txt)
- `tests/services/ollama-gateway/` (__init__.py, test_vllm_backend.py)
- `tests/inject_buy_signal_mq.py`, `tests/inject_sell_signal_mq.py`, `tests/check_mq_queue.py`
- `manual_buy_trigger.py`

## 테스트 결과
- `tests/shared/`: 1162 passed, 1 skipped
- `tests/services/`: 174 passed
- `tests/integration/`: 4 passed
- `tests/scripts/` (단독): 31 passed
- **총 1371 passed** (macro_council 23개 실패는 기존 테스트 격리 문제, 원본에서도 동일)

## 롤백 전략
- **RabbitMQ 복원**: `git restore shared/rabbitmq.py` + docker-compose에 rabbitmq 서비스 추가 + RABBITMQ_URL env var 복원
- **Gateway 복원**: `git restore services/ollama-gateway/` + docker-compose에 서비스 추가 + USE_OLLAMA_GATEWAY=true 설정
- 두 변경은 별도 커밋이 아닌 한 커밋이므로, 전체 revert 또는 파일 단위 restore 필요

## 다음 단계 (TODO)
- [ ] Docker 이미지 전체 재빌드 및 배포 (`docker compose --profile real up -d --build`)
- [ ] 프로덕션 정상 동작 확인 (buy-signals/sell-orders Redis Streams 소비 확인)
- [ ] Dashboard 프론트엔드 RabbitMQ UI 섹션 제거 (현재 빈 응답 반환 중)
- [ ] `tests/e2e/fixtures/rabbitmq_fixtures.py` → Redis Streams fixtures로 교체
- [ ] macro_council 테스트 격리 문제 조사 (다른 테스트와 동시 실행 시 23개 실패)
