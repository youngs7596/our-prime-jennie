# Session Handoff: News Collector Redis 영속 중복 체크 구현

## 요약 (Summary)
뉴스 수집기(news-collector)가 인메모리 Python set으로 중복 체크하던 것을 Redis SET 기반 영속 중복 체크로 전환.
컨테이너 재시작/재배포 시에도 최근 3일 뉴스 해시가 유지되어 중복 발행 방지.

## 변경 사항 (Changes)

### 신규 파일
- `tests/shared/test_news_deduplicator.py`: NewsDeduplicator 테스트 18개 (compute_news_hash, is_seen, mark_seen, check_and_mark, filter_new_batch + 에러 폴백)

### 수정 파일
- `shared/messaging/stream_client.py`:
  - `compute_news_hash()` 함수 추가 (정규화 + MD5 12자리)
  - `NewsDeduplicator` 클래스 추가 (날짜별 Redis SET `dedup:news:YYYYMMDD`, 3일 TTL)
  - 메서드: `is_seen()`, `mark_seen()`, `check_and_mark()`, `filter_new_batch()`
  - Redis 실패 시 안전 폴백 (전체를 신규로 처리)
- `services/news-collector/collector.py`:
  - `_seen_rss_hashes` 인메모리 set → `NewsDeduplicator` 인스턴스로 교체
  - RSS 뉴스: `check_and_mark()`로 개별 Redis dedup
  - 발행 전: `filter_new_batch()`로 전체 문서 배치 dedup (naver.py 인메모리 보완)

### 미변경 파일
- `shared/crawlers/naver.py`: 인메모리 `_seen_news_hashes` 유지 (세션 내 HTTP 재크롤링 방지 용도)

### 테스트 결과
- 신규: 18 passed (test_news_deduplicator.py)
- shared: 1113 passed, 1 skipped
- 전체 통과 (0 failures)

## 아키텍처 결정
- **2단계 dedup**: 1차 인메모리(세션 내 최적화) + 2차 Redis(영속 중복 방지)
- **날짜별 Redis SET**: `dedup:news:20260208` 형태, 3일 TTL 자동 만료로 무한 증가 방지
- **naver.py 미변경**: 순수 크롤러 모듈에 Redis 의존성 추가 불필요 (collector 레벨에서 처리)

## 다음 단계 (Next Steps)
- [ ] Docker 빌드 + 배포: `docker compose --profile real up -d --build news-collector`
- [ ] Redis에 dedup SET 생성 확인: `redis-cli keys "dedup:news:*"`
- [ ] 로그에서 `[Dedup] 영속 중복 제거: N개` 메시지 확인
- [ ] 이전 세션 미완료: `python scripts/collect_foreign_holding_ratio.py --days 30` (DB 백필)
- [ ] 이전 세션 미완료: v2 실전 IC 모니터링

## Context for Next Session
- `shared/messaging/stream_client.py`: NewsDeduplicator 클래스
- `services/news-collector/collector.py`: Redis dedup 적용 부분
- `tests/shared/test_news_deduplicator.py`: 테스트 파일

## 롤백 플랜
- `collector.py`에서 `_deduplicator` → 인메모리 `set()`으로 복원 시 즉시 원복
- `stream_client.py`의 NewsDeduplicator 클래스는 다른 코드에서 미사용 (삭제 안전)
