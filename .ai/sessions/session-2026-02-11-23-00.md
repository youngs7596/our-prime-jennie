# Session Handoff: 2026-02-11 23:00

## 세션 주제
모멘텀 전략 실행 파이프라인 최적화 — 지정가 주문 + 확인 바

## 배경
모멘텀 계열 4개 전략(MOMENTUM, MOMENTUM_CONTINUATION_BULL, SHORT_TERM_HIGH_BREAKOUT, VCP_BREAKOUT)이
반복적으로 고점 매수를 하는 문제. 원인은 1분봉 완성 대기(~30초) + 시장가 주문 슬리피지(+1~5%).
3현자 검토 결과 **전략 로직 미변경, 실행 파이프라인만 최적화**하기로 결정.

## 변경 내역

### 1. 설정 추가 (4개 키)
| 키 | 타입 | 기본값 | 설명 |
|----|------|--------|------|
| `MOMENTUM_LIMIT_ORDER_ENABLED` | bool | false | 지정가 주문 활성화 |
| `MOMENTUM_LIMIT_PREMIUM` | float | 0.003 | 지정가 프리미엄 (+0.3%) |
| `MOMENTUM_LIMIT_TIMEOUT_SEC` | int | 10 | 미체결 취소 대기(초) |
| `MOMENTUM_CONFIRMATION_BARS` | int | 0 | 확인 바 수 (0=비활성) |

### 2. buy-scanner: 확인 바 (`opportunity_watcher.py`)
- `MOMENTUM_STRATEGIES` 상수 정의 (파일 상단)
- `pending_momentum_signals` dict + `momentum_confirmation_bars` 설정 (`__init__`)
- `on_price_update()`: completed_bar 시 pending 확인 우선 체크
- `_check_pending_momentum()`: 다음 봉 종가 >= 시그널가 → 발행, 하락 → 폐기
- `_check_buy_signal()`: 모멘텀 전략 감지 시 signal dict 구성 후 pending 저장 (publish 안 함)

### 3. buy-executor: 지정가 주문 (`executor.py`)
- `MOMENTUM_STRATEGIES` 상수 정의 (파일 상단)
- 3-way 분기: dry-run(limit/market), live limit(timeout+cancel), live market
- `_record_trade()`: `order_type`, `limit_price` 파라미터 추가 → `key_metrics`에 기록

### 4. 인프라
- `registry.py`: 4개 설정 키 추가
- `env-vars-wsl.yaml`: 4개 env var 추가
- `docker-compose.yml`: buy-scanner에 `MOMENTUM_CONFIRMATION_BARS`, buy-executor에 나머지 3개

## 롤백 전략
**모든 기능이 기본 비활성화** — 배포 즉시 동작 변화 없음.
- `MOMENTUM_LIMIT_ORDER_ENABLED=false` → 시장가 주문 유지
- `MOMENTUM_CONFIRMATION_BARS=0` → 즉시 시그널 발행

## 테스트 결과
- buy-executor: 26/26 passed
- buy-scanner: 16/16 passed
- price-monitor: 12/12 passed

## 커밋
1. `d32aafa` chore: 이전 세션 미커밋 파일 정리
2. `a37f3b6` feat(execution): 모멘텀 전략 지정가 주문 + 확인 바 — 고점 매수 방지

## 수정 파일 목록
| 파일 | 변경 |
|------|------|
| `shared/settings/registry.py` | 4개 설정 키 추가 |
| `infrastructure/env-vars-wsl.yaml` | 4개 env var 추가 |
| `docker-compose.yml` | buy-scanner, buy-executor environment 추가 |
| `services/buy-scanner/opportunity_watcher.py` | MOMENTUM_STRATEGIES, pending 시그널, _check_pending_momentum() |
| `services/buy-executor/executor.py` | MOMENTUM_STRATEGIES, 지정가 주문 분기, key_metrics 기록 |

## 다음 단계 (TODO)
1. **활성화 테스트**: `MOMENTUM_CONFIRMATION_BARS=1`, `MOMENTUM_LIMIT_ORDER_ENABLED=true` 설정 후 장중 모니터링
2. **성과 추적**: `key_metrics.order_type` 필드로 limit vs market 체결률/슬리피지 비교 분석
3. **파라미터 튜닝**: premium (0.3%) 및 timeout (10s) 값 최적화
4. **cancel_order 반환값 검증**: KIS API cancel_order가 "이미 체결" 시 정확히 False를 반환하는지 실전 확인 필요
