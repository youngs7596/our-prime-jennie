# Session Handoff: KIS Gateway Token Persistence Fix

**Date**: 2026-02-01 01:25 KST
**Branch**: `development`
**Last Commit**: `99ca9b0 fix(tests): Update mocks to use SQLAlchemy 2.0 style methods`

---

## Summary

KIS Gateway 컨테이너 crash-loop 문제 해결. 토큰 파일이 컨테이너 재시작 시 유실되어 KIS API rate limit (1분당 1회) 에 반복적으로 걸리는 문제였음.

---

## Problem

```
❌ (Auth) 토큰 발급 실패 (403 Forbidden):
응답={"error_description":"접근토큰 발급 잠시 후 다시 시도하세요(1분당 1회)","error_code":"EGW00133"}
```

**원인 분석**:
1. 토큰 파일이 `/tmp/kis_token_gateway.json` (컨테이너 내부)에 저장
2. 컨테이너 재시작 시 `/tmp` 초기화 → 토큰 유실
3. 재시작할 때마다 새 토큰 발급 시도 → rate limit 히트 → 실패 → 재시작 (무한 루프)

---

## Fix Applied

### 1. docker-compose.yml 수정

```yaml
kis-gateway:
  volumes:
    - ./secrets.json:/app/config/secrets.json:ro
    - /docker_data/kis_tokens:/app/tokens          # NEW
  environment:
    - PORT=8080
    - SECRETS_FILE=/app/config/secrets.json
    - GUNICORN_CMD_ARGS=--timeout 600
    - KIS_TOKEN_FILE_PATH=/app/tokens/kis_token.json  # NEW
```

### 2. services/kis-gateway/main.py:324 수정

**Before**:
```python
token_file_path="/tmp/kis_token_gateway.json",
```

**After**:
```python
token_file_path=os.getenv("KIS_TOKEN_FILE_PATH", "/tmp/kis_token_gateway.json"),
```

### 3. 호스트 디렉토리 생성

```bash
mkdir -p /docker_data/kis_tokens
```

---

## Files Changed

```
docker-compose.yml                  # 볼륨 마운트 및 환경변수 추가
services/kis-gateway/main.py        # 토큰 경로 환경변수 사용
```

---

## Verification

컨테이너 재시작 후 캐시된 토큰 사용 확인:
```
shared.kis.auth - INFO - (Auth) ✅ 유효한 캐시 토큰 사용. (잠금 내)
main - INFO - ✅ KIS Client 초기화 완료 (토큰 발급 성공)
```

---

## Current State

- **kis-gateway**: 정상 작동 ✅ (healthy)
- **토큰 지속성**: `/docker_data/kis_tokens/kis_token.json`에 저장 ✅
- **커밋**: 미완료 (변경사항 있음)

---

## TODO / Next Steps

1. **커밋 필요**: 이번 세션 변경사항 커밋
2. **SQLAlchemy 2.0 마이그레이션 확장** (이전 세션에서 이어짐)
3. **테스트 커버리지 확대**

---

## Commands for Next Session

```bash
# 변경사항 확인
git status
git diff

# 커밋
git add docker-compose.yml services/kis-gateway/main.py
git commit -m "fix(kis-gateway): Persist token file across container restarts"

# 컨테이너 상태 확인
docker ps | grep kis-gateway
docker logs my-prime-jennie-kis-gateway-1 --tail 20
```

---

*Last Updated: 2026-02-01 01:25 KST*
