# Session Handoff: Portfolio Architecture Refactoring

## 요약 (Summary)
포트폴리오 데이터 정합성 문제를 근본적으로 해결하기 위해 `ActivePortfolio` 테이블을 신규 생성하고 기존 데이터를 이관했습니다. 기존의 `PORTFOLIO` 테이블은 이력성 데이터로 남겨두고, 실제 거래 및 조회 로직은 모두 새로운 `ACTIVE_PORTFOLIO` 테이블을 사용하도록 리팩토링했습니다. 이를 통해 중복 홀딩(`HOLDING`) 생성 버그를 DB 제약조건 레벨에서 원천 차단했습니다.

## 변경 사항 (Changes)
- **`shared/db/models.py`**: `ActivePortfolio` 모델 정의 추가 (`stock_code` PK).
- **`utilities/migrate_to_active_portfolio.py`**: 기존 `PORTFOLIO` 데이터 중 `HOLDING` 상태인 7건을 `ACTIVE_PORTFOLIO`로 이관하는 마이그레이션 스크립트 작성 및 실행.
- **`shared/database/trading.py`**:
  - `get_active_portfolio`: `ActivePortfolio` 테이블 조회로 변경.
  - `remove_from_portfolio`: `ActivePortfolio` 테이블에서 row 삭제(전량매도) 또는 업데이트(부분매도)로 로직 단순화.
  - `_execute_trade_and_log_sqlalchemy`: `BUY` 시 `UPSERT` 로직 적용, `SELL` 시 `DELETE` 로직 적용.
- **`CHANGELOG.md`**: 작업 내역 업데이트.

## 다음 단계 (Next Steps)
- [ ] **통합 테스트**: 내일 장 시작 전/후에 실제 매수/매도 주문 사이클이 `ACTIVE_PORTFOLIO`와 `TRADELOG`에 정상 반영되는지 모니터링 필요.
- [ ] **Legacy Cleanup**: 향후 `PORTFOLIO` 테이블의 의존성이 완전히 제거되었는지 확인 후, 필요 시 백업 후 삭제 또는 아카이빙 테이블로 명시적 전환 고려.
- [ ] **Dashboard Update**: 대시보드에서 포트폴리오를 조회하는 API도 `ActivePortfolio`를 바라보는지 확인 (현재 `shared/db/repository.py` 등을 사용한다면 자동 반영되었을 것임, 확인 필요).
