# Session Handoff: Macro Insight Module & 3현자 Council Integration

## 요약
텔레그램 증권사 리서치 채널에서 매크로 인사이트를 수집하고 분석하는 전체 파이프라인을 구현했습니다. 3현자 Council을 활용하여 @hedgecat0301 (키움 한지영) 채널의 일일 브리핑을 심층 분석하고, 구조화된 인사이트를 DB/Redis에 저장합니다.

## 주요 변경사항

### 1. 새 서비스 (Docker 배포)
- **telegram-collector**: 텔레그램 채널 메시지 수집 (Telethon 기반)
- **macro-aggregator**: 매크로 신호 집계 및 분류
  - `MACRO_LLM_MODE=auto`: 장외 시간에만 gpt-oss LLM 사용 (06:00~08:00, 16:00~06:00 KST)
  - 장중에는 규칙 기반 분석 (scout-worker와 VRAM 충돌 방지)

### 2. 3현자 Council 매크로 분석
- **scripts/run_macro_council.py**: 일일 매크로 분석 작업
  - Jennie (Gemini) + Minji (Claude) + Junho (GPT-4o) 분석
  - 비용: ~$0.20/일 (≈290원)
  - 실행: 매일 07:30 KST 권장

### 3. DB 테이블
```sql
CREATE TABLE DAILY_MACRO_INSIGHT (
    ID INT AUTO_INCREMENT PRIMARY KEY,
    INSIGHT_DATE DATE NOT NULL,
    SENTIMENT VARCHAR(30),         -- neutral_to_bullish 등
    SENTIMENT_SCORE INT,           -- 0-100
    REGIME_HINT VARCHAR(50),       -- HighVolatility_KOSDAQ_Led 등
    SECTOR_SIGNALS JSON,
    KEY_THEMES JSON,
    RISK_FACTORS JSON,
    KEY_STOCKS JSON,
    RAW_MESSAGE TEXT,
    RAW_COUNCIL_OUTPUT JSON,
    COUNCIL_COST_USD DECIMAL(10,4),
    ...
);
```

### 4. 서비스 활용 함수 (shared/macro_insight/)
```python
from shared.macro_insight import (
    get_today_insight,          # 오늘 인사이트 조회
    get_position_multiplier,    # 포지션 사이즈 배율 (0.7~1.3x)
    get_sector_signal,          # 섹터별 신호 (bullish/neutral/bearish)
    is_high_volatility_regime,  # 고변동성 국면 여부
    get_stop_loss_multiplier,   # 손절 폭 배율 (1.0~1.5x)
    should_skip_sector,         # 섹터 진입 스킵 여부
)
```

## 파일 변경 목록

### 신규 생성
- `services/telegram-collector/` - 텔레그램 수집 서비스
  - collector.py, channels.py, Dockerfile, requirements.txt
- `services/macro-aggregator/` - 매크로 집계 서비스
  - aggregator.py, Dockerfile, requirements.txt
- `shared/macro_insight/` - 매크로 인사이트 모듈
  - macro_sentiment_analyzer.py
  - macro_signal_aggregator.py
  - daily_insight.py (3현자 결과 저장/조회)
- `scripts/run_macro_council.py` - 일일 Council 분석
- `scripts/telegram_auth.py` - 텔레그램 인증 도구
- `tests/shared/macro_insight/` - 38개 테스트

### 수정
- `docker-compose.yml` - telegram-collector, macro-aggregator 서비스 추가
- `shared/market_regime.py` - detect_regime_with_macro() 추가
- `shared/messaging/stream_client.py` - STREAM_MACRO_RAW, GROUP_MACRO_ANALYZER 추가

## 테스트 결과
```
tests/shared/macro_insight/ - 38 passed ✅
tests/shared/test_market_regime.py - 30 passed ✅
```

## 실행 확인
```
# 텔레그램 메시지 수집: 31개 (3개 채널)
# 3현자 Council 분석: $0.20/회
# DB 저장: DAILY_MACRO_INSIGHT 테이블
# Redis 캐시: macro:daily_insight 키
```

## 다음 단계 (TODO)
- [ ] 스케줄러에 07:30 KST macro_council 작업 등록
- [ ] scout-worker에 get_sector_score_adjustment() 연동
- [ ] buy-executor에 get_position_multiplier() 연동
- [ ] price-monitor에 get_stop_loss_multiplier() 연동
- [ ] 대시보드에 오늘의 매크로 인사이트 표시

## 환경 변수
```yaml
# docker-compose.yml
MACRO_LLM_MODE: auto  # auto | true | false
```

## 운영 비용
- 3현자 Council: ~$0.20/일 × 22일 = ~$4.4/월 (≈6,400원)
- 로컬 LLM (장중): ₩0 (gpt-oss 시간 분리 운영)
