# Session Handoff: FOREIGN_HOLDING_RATIO 수집 + Quant Scorer v2 프로덕션 전환

## 요약 (Summary)
Quant Scorer v2 백테스트에서 IC 양수 전환(v1: -0.071 → v2: +0.106)이 확인됨에 따라,
누락되었던 FOREIGN_HOLDING_RATIO 데이터 수집 파이프라인을 구축하고 v2를 프로덕션에 적용.

## 변경 사항 (Changes)

### 신규 파일
- `scripts/collect_foreign_holding_ratio.py`: pykrx 기반 외인보유비율(지분율%) 수집 스크립트
  - KOSPI + KOSDAQ 전종목 대상, DDL 자동 실행 (ALTER TABLE ADD COLUMN)
  - `--days N` (백필) / `--date YYYYMMDD` (특정일) 옵션

### 수정 파일
- `dags/utility_jobs_dag.py`: DAG #7 `collect_foreign_holding_ratio` 추가 (18:35 KST, 월~금)
  - collect_investor_trading(18:30) 이후 5분 뒤 실행
- `docker-compose.yml`: scout-job & scout-worker `QUANT_SCORER_VERSION=v1` → `v2` 전환
- `scripts/backtest_v2_historical.py`: `get_foreign_ratio_trend_at()` 실제 DB 데이터 사용 (기존 `return None` 제거)
- `scripts/dryrun_v1_v2_comparison.py`: `investor_ext` 활성화 (`factor_repo.get_investor_trading_with_ratio()` 호출)

### 테스트 결과
- shared: 1095 passed, 1 skipped
- v2 quant scorer: 46 passed
- scout-job: 18 passed

### 백테스트 결과 (Watchlist 28일, 330건)
- v1 D+5 IC=-0.071, v2 D+5 IC=+0.106 → v2 IC 0.177 개선 (양수 전환)
- v2 60-70점대: 승률 69.2%, 평균 +5.16% (핵심 매수 구간)
- v1↔v2 Rank 상관: 0.696

## 다음 단계 (Next Steps)
- [ ] `python scripts/collect_foreign_holding_ratio.py --days 30` 실행 (DB 백필)
- [ ] 백필 후 `python scripts/backtest_v2_historical.py --days 28` 재실행 (외인비율 팩터 포함 IC 확인)
- [ ] Docker 빌드 + 배포 (v2 적용): `docker compose -p my-prime-jennie --profile real up -d --build scout-job scout-worker`
- [ ] v2 실전 IC 모니터링 (1주 후 v1 대비 성과 비교)
- [ ] Unified Analyst 실전 성과 모니터링 (risk_tag 분포 확인)

## Context for Next Session
- `scripts/collect_foreign_holding_ratio.py`: 외인보유비율 수집 스크립트 (백필 실행 필요)
- `shared/hybrid_scoring/quant_scorer.py`: v2 스코어링 로직 (`_calculate_supply_demand_v2()` — foreign_ratio_trend 활용)
- `services/scout-job/scout_pipeline.py`: v2_caches.investor_trading_ext → FOREIGN_HOLDING_RATIO 사용 부분
- `docker-compose.yml`: QUANT_SCORER_VERSION=v2 확인

## 롤백 플랜
- `QUANT_SCORER_VERSION=v1`로 환경변수 변경 시 즉시 v1 복원
- 기존 v1 로직 코드 모두 유지됨 (삭제 없음)
