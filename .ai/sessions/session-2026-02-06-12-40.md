# Session Handoff: Airflow DAG 수정 & 매크로 대시보드 데이터 복구

## 요약 (Summary)
Airflow BashOperator `append_env=True` 일괄 적용, 매크로 대시보드 글로벌 지표/투자자 순매수 데이터 누락 원인 2건 수정, 과거 날짜 backfill 완료.

## 변경 사항 (Changes)

### 1. Airflow DAG append_env=True 일괄 적용
BashOperator에 `env=COMMON_ENV`만 설정하면 시스템 PATH 등이 사라지는 문제 수정.
- **`dags/utility_jobs_dag.py`**: 6개 BashOperator에 `append_env=True` 추가
- **`dags/enhanced_macro_collection_dag.py`**: 4개 BashOperator
- **`dags/macro_council_dag.py`**: 1개 BashOperator
- **`dags/host_consolidated_dag.py`**: 3개 BashOperator + 중복 bash export 정리
- **`dags/daily_asset_snapshot_dag.py`**: 1개 BashOperator
- 전체 9개 DAG 수동 트리거 → 모두 성공 확인

### 2. 매크로 대시보드 데이터 누락 수정 (Root Cause 2건)
**RC1: pykrx/feedparser 미설치**
- `services/airflow/requirements.txt`에 `pykrx>=1.0.0`, `feedparser>=6.0.0` 추가
- Airflow 컨테이너에서 pykrx import 실패 → KOSPI/KOSDAQ/투자자 데이터 silent fail

**RC2: 장중 미래 타임스탬프 필터링**
- `shared/macro_data/clients/pykrx_client.py` `fetch_index()` 수정
- 기존: 항상 15:30 KST 타임스탬프 → DataValidator가 "미래 데이터"로 필터링
- 수정: 장중(`now.hour < 15`)이면 현재 시각 사용

### 3. 기타 (이전 세션 미커밋 포함)
- **`services/price-monitor/monitor.py`**: 미사용 profit_floor 로직 제거
- **`shared/redis_cache.py`**: 손절 쿨다운 TTL 거래일→캘린더일 변환 (×1.4 보정)
- **`infrastructure/env-vars-wsl.yaml`**: P0 트레이딩 env vars 추가

### 4. DB Backfill (코드 변경 없음, DB 직접 업데이트)
- ENHANCED_MACRO_SNAPSHOT + DAILY_MACRO_INSIGHT: 2/3(월), 2/5(수) 데이터 채움
- pykrx로 KOSPI/KOSDAQ 지수, 투자자별 순매수(외국인/기관/개인) 수집 후 UPDATE

## 커밋 이력
- `9056c03` Fix Airflow DAG failures: add append_env=True + profit_floor removal
- `d6329f4` Fix stoploss cooldown TTL: convert trading days to calendar days
- `f3542f8` Add P0 trading logic env vars
- `ebb0c23` Fix empty macro dashboard: add pykrx/feedparser to Airflow, fix future timestamp filter

## 현재 상태 (Current State)
- 대시보드 매크로 페이지: 2/3~2/6 모든 날짜 글로벌 지표 + 투자자 순매수 정상 표시
- 전체 DAG 9개 수동 실행 성공 확인
- 2/1(토), 2/2(일)은 주말이라 데이터 없음 (정상)

## 다음 단계 (Next Steps)
- [ ] 주말 날짜(2/1, 2/2) ENHANCED_MACRO_SNAPSHOT 레코드 정리 검토
- [ ] macro_council DAG 자동 스케줄 확인 (07:30 KST 정상 동작하는지)
- [ ] enhanced_macro_collection completeness_score 개선 (현재 0.71)

## Context for Next Session
- `shared/macro_data/clients/pykrx_client.py` — 미래 타임스탬프 수정 (line 279~287)
- `shared/macro_data/validator.py` — future timestamp 필터 (line 178)
- `services/airflow/requirements.txt` — pykrx, feedparser 추가
- `dags/` — 모든 BashOperator에 append_env=True 적용 완료
