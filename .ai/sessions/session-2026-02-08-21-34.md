# Session Handoff: Daily Briefing Claude Opus 4.6 전환 + 뉴스 조회 수정

## 요약 (Summary)
Daily Briefing 서비스의 3가지 장애 원인을 수정:
1. LLM을 deepseek_cloud(THINKING tier) → Claude Opus 4.6 직접 호출로 전환
2. NEWS_SENTIMENT 쿼리 SQL 에러 수정 (컬럼명 + STOCK_MASTER JOIN + Collation)
3. ClaudeLLMProvider secrets.json 자동 조회 폴백 추가

## 변경 사항 (Changes)
- `shared/llm.py`: `generate_daily_briefing()` Claude Opus 4.6 직접 호출 (THINKING tier 의존 제거), 환경변수 `BRIEFING_LLM_MODEL`로 모델 오버라이드 가능, Claude 실패 시 THINKING tier 폴백
- `shared/llm_providers.py`: `ClaudeLLMProvider.__init__()` secrets.json 자동 조회 폴백 추가 (인자 없이 호출해도 API 키 로드)
- `shared/auth.py`: `local_env_mapping`에 `"claude-api-key": "ANTHROPIC_API_KEY"` 추가
- `services/daily-briefing/reporter.py`: `_get_recent_news_sentiment()` SQL 수정
  - `STOCK_NAME` → `STOCK_MASTER` LEFT JOIN으로 종목명 조회
  - `HEADLINE` → `NEWS_TITLE` (실제 컬럼명)
  - `COLLATE utf8mb4_unicode_ci` 추가 (테이블 간 collation 불일치 해소)
- `tests/shared/test_llm_brain.py`: Claude 직접 호출 패턴에 맞게 mock 수정, 폴백 시나리오 테스트 추가

## 테스트 결과
- shared + daily-briefing: 1118 passed, 1 skipped
- LLM brain: 47 passed (briefing 4개 포함)
- 실제 배포 후 텔레그램 브리핑 정상 수신 확인

## 다음 단계 (Next Steps)
- [ ] 평일 17:00 Airflow DAG 자동 실행 확인 (daily_briefing_report)
- [ ] 뉴스 데이터가 있는 평일에 뉴스 섹션 포함 여부 확인
- [ ] Claude Opus 4.6 비용 모니터링 (일 1회 호출, ~$0.05 예상)

## Context for Next Session
- `shared/llm.py` — generate_daily_briefing() Claude Opus 4.6 전용
- `shared/llm_providers.py` — ClaudeLLMProvider secrets.json 폴백
- `services/daily-briefing/reporter.py` — NEWS_SENTIMENT SQL 수정
