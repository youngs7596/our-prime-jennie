# Session 2026-02-18 21:00 — Macro Council 휴장일 가드 + 정치뉴스 고도화

## 목적
설 연휴(2/16-18) 3일간 KRX 휴장 시에도 macro_council DAG가 실행되어 ~$0.60 낭비.
RSS 피드에서 오래된/무관한 정치 뉴스가 LLM에 전달되어 잘못된 분석 유발.

## 변경사항

### 1. KRX 휴장일 가드
- `shared/kis/market_data.py`: `is_trading_day(target_date)` 메서드 추가 (시간 무관, 날짜만 체크)
- `shared/kis/client.py`: `is_trading_day()` 바로가기 메서드 추가
- `services/kis-gateway/main.py`: `GET /api/market-data/is-trading-day` 엔드포인트 추가
- `shared/kis/gateway_client.py`: `is_trading_day()` 클라이언트 메서드 추가
- `scripts/run_macro_council.py`: `main()` 상단에 주말/휴장일 가드 삽입
  - 주말 → 즉시 스킵 (Gateway 호출 불필요)
  - 평일 → Gateway API로 KIS 휴장일 체크
  - Gateway 실패 시 fail-open (비용 $0.20 vs 분석 누락)
  - `DISABLE_HOLIDAY_CHECK=true` / `--dry-run`으로 우회 가능

### 2. RSS 기사 날짜 검증 강화
- `get_political_news_headlines()`: `max_age_hours` 24→18 축소
- 헤드라인에 `published_at` 필드 추가
- `_build_context_text()`: 뉴스 라인에 발행 시간 포함, 헤더 "최근 18시간"으로 변경

### 3. 정치/지정학적 뉴스 키워드 고도화
- `_detect_keywords()`: 5자 이하 ASCII 키워드에 `\b` word boundary 적용
  - 예: "war"가 "award"에 매칭되는 것 방지
- `KEYWORD_CONFIG` 전면 개편:
  - `us_politics`: severity high→medium, "trump"/"biden" 단독 키워드 제거
  - `us_trade_policy`: 신규 카테고리 (critical) — 한미 무역 직접 영향
  - `geopolitical`: 단독 "war", "military" 등 제거 → 복합 키워드 (missile launch, nuclear test 등)
  - `crisis`: 단독 "recession", "crash" 등 제거 → 복합 키워드 (recession warning, market crash 등)

### 4. LLM 프롬프트 그라운딩 지시 추가
- `macro_strategist.txt`: 원칙 5,6 추가 (뉴스 기반만 평가, 오래된 뉴스 가중치 축소)
- `macro_risk_analyst.txt`: 원칙 5,6 추가 (구체적 이벤트만 근거, political_risk_level 기준 명시)

## 테스트 결과

| Suite | Passed | Notes |
|-------|--------|-------|
| macro_council_pipeline | 47 | +8 holiday guard, +2 published_at |
| political_news_client | 20 | 신규 (word boundary 5, compound 6, us_trade 4, severity 3, hints 2) |
| macro_data 전체 | 102 | 1 pre-existing fail (VIX mock) |
| **신규 합계** | **28** | |

## 롤백
- `DISABLE_HOLIDAY_CHECK=true` → 휴장일 가드 비활성
- 키워드: `KEYWORD_CONFIG` dict → git revert
- 프롬프트: txt 파일 → git revert

## 파일 변경 목록
- `shared/kis/market_data.py` — `is_trading_day()` 추가
- `shared/kis/client.py` — `is_trading_day()` 위임
- `services/kis-gateway/main.py` — `/api/market-data/is-trading-day` 엔드포인트
- `shared/kis/gateway_client.py` — `is_trading_day()` 메서드
- `scripts/run_macro_council.py` — 휴장일 가드 + published_at + max_age 축소
- `shared/macro_data/clients/political_news_client.py` — word boundary + 키워드 전면 개편
- `prompts/council/macro_strategist.txt` — 그라운딩 지시 추가
- `prompts/council/macro_risk_analyst.txt` — 그라운딩 지시 추가
- `tests/scripts/test_macro_council_pipeline.py` — 8 holiday guard + 2 published_at 테스트 추가
- `tests/shared/macro_data/test_political_news_client.py` — 신규 20개 테스트
- `.ai/sessions/session-2026-02-18-21-00.md` — 이 세션 기록
- `docs/changelogs/CHANGELOG-2026-02.md` — 변경 이력 추가
