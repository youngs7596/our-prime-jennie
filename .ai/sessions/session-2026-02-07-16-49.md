# Session Handoff: Unified Analyst Pipeline + 네이버 섹터 통합

## 요약 (Summary)
3현자 Council 합의(90-95%)에 따라 3단계 LLM 파이프라인(Hunter→Debate→Judge)을 1회 호출 Unified Analyst로 통합.
네이버 금융 79개 업종 세분류를 Single Source of Truth로 통합 (3종 분산 섹터 분류 제거).

## 변경 사항 (Changes)

### Unified Analyst Pipeline (3→1 LLM 호출 통합)
- `shared/hybrid_scoring/quant_scorer.py`: `classify_risk_tag()` 추가 — 코드 기반 risk_tag (LLM 100% CAUTION 편향 해소)
- `shared/llm_prompts.py`: `build_analyst_prompt()` 추가 — 통합 Analyst 프롬프트
- `shared/llm_constants.py`: `ANALYST_RESPONSE_SCHEMA` 추가 (risk_tag 없는 간결 스키마)
- `shared/llm.py`: `run_analyst_scoring()` 추가 — REASONING tier 1회 호출
- `services/scout-job/scout_pipeline.py`: `process_unified_analyst_task()` 추가 — Phase1+Phase2-3 통합
- `services/scout-job/scout.py`: 1-pass 통합 + `SCOUT_USE_UNIFIED_ANALYST` 환경변수 토글
- `docker-compose.yml`: `SCOUT_USE_UNIFIED_ANALYST=true` env var 추가

### 네이버 업종 분류 통합
- `shared/sector_taxonomy.py`: NAVER_TO_GROUP 대분류 매핑 (79개 세분류 → ~14개 대분류)
- `shared/sector_classifier.py`: v4.0 — SECTOR_NAVER 우선 조회
- `shared/crawlers/naver.py`: 크롤러 3개 함수 추가
- `shared/db/models.py`: SECTOR_NAVER, SECTOR_NAVER_GROUP 컬럼 추가
- `shared/db/factor_repository.py`: SECTOR_NAVER 우선 조회
- `services/scout-job/scout_universe.py`: SECTOR_MAPPING 삭제 → DB 기반 `_resolve_sector()`
- `shared/hybrid_scoring/factor_analyzer.py`: SECTOR_MAPPING 삭제 → DB 기반 조회
- `utilities/update_naver_sectors.py`: 배치 업데이트 스크립트

### 테스트 (32개 신규)
- `tests/shared/hybrid_scoring/test_quant_scorer.py`: `TestClassifyRiskTag` 9개
- `tests/shared/test_llm_prompts.py`: `TestBuildAnalystPrompt` 9개
- `tests/shared/test_llm_brain.py`: `TestRunAnalystScoring` 6개
- `tests/services/scout-job/test_scout_pipeline.py`: `TestProcessUnifiedAnalystTask` 8개
- 전체: 1049 shared + 18 scout-job 테스트 통과

## 핵심 설계 결정
- **코드 기반 risk_tag**: LLM이 아닌 `classify_risk_tag(quant_result)`가 결정 (RSI, DD, flow_reversal 기반)
- **±15pt 가드레일**: `llm_score = clamp(raw, quant-15, quant+15)` — LLM 과잉 낙관/비관 방지
- **환경변수 토글**: `SCOUT_USE_UNIFIED_ANALYST=true` (false면 기존 2-pass 폴백)
- **기존 코드 유지**: Hunter/Debate/Judge 함수 삭제하지 않음 (안전한 롤백)

## 다음 단계 (Next Steps)
- [ ] Docker 빌드 후 scout 1회 실행 (`DISABLE_MARKET_OPEN_CHECK=true`), risk_tag 분포 확인
- [ ] `python utilities/update_naver_sectors.py` 실행 (DB에 SECTOR_NAVER 데이터 투입)
- [ ] QUALITY_VALUE 가중치 전환 검토 (rolling window 검증 필요, 현재 HOLD)
- [ ] Unified Analyst 실전 IC 모니터링 (1주 후 기존 2-pass 대비 성과 비교)

## Context for Next Session
- `services/scout-job/scout_pipeline.py`: `process_unified_analyst_task()` (핵심 통합 파이프라인)
- `shared/hybrid_scoring/quant_scorer.py`: `classify_risk_tag()` (코드 기반 risk_tag)
- `shared/llm.py`: `run_analyst_scoring()` (1회 LLM 호출)
- `utilities/update_naver_sectors.py`: 배치 스크립트 (초기 실행 필요)

## 롤백 플랜
- `SCOUT_USE_UNIFIED_ANALYST=false`로 환경변수 변경 시 기존 2-pass 로직 즉시 복원
- 기존 Hunter/Debate/Judge 코드 모두 유지됨
