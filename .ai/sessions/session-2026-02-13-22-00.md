# Session: 3-Layer 테스트 강화 + Buy-Scanner 선제 진입

**Date**: 2026-02-13 22:00 KST
**Branch**: development

## 변경 요약

### 1. Buy-Scanner 선제 진입 + 추격매수 방지 (이전 세션 미커밋 분)

- **WATCHLIST_CONVICTION_ENTRY**: Scout 고확신 종목 장 초반(09:15-10:30) 선제 매수
  - 조건: BULL/STRONG_BULL + hybrid>=70 OR llm>=72 + D+0~2 + 상승률<3% + VWAP이격<1.5% + RSI<65
  - RECON_BULL_ENTRY 대체 (삭제됨), 시장가 주문
- **사문화 전략 비활성화**: BULL_PULLBACK, VCP_BREAKOUT, INSTITUTIONAL_ENTRY, SHORT_TERM_HIGH_BREAKOUT (기본 false)
- **DIP_BUY 국면별 완화**: BULL -0.5~-3.0%, max_days 5일
- **MOMENTUM 추격매수 방지**: MOMENTUM_MAX_GAIN_PCT=7.0%, MOMENTUM_CONT_MAX_GAIN_PCT=5.0%
- **데이터 파이프라인**: trade_tier/hybrid_score → scout_cache→watchlist→buy-scanner 전달

### 2. 3-Layer 테스트 강화 (이번 세션)

| Layer | 파일 | 테스트 수 | 목적 |
|-------|------|----------|------|
| 1 (Contract) | `tests/shared/test_contracts.py` (신규) | 12 | 서비스 간 데이터 계약 + API 라우트 매핑 |
| 2 (Spec Mock) | `tests/shared/broker/test_kis_adapter.py` (수정) | 4 | create_autospec vs MagicMock 차이 검증 |
| 3 (Boundary) | `tests/services/buy-scanner/test_conviction_entry.py` (수정) | 12 | 경계값/음성 테스트 |

#### Layer 1: Contract Tests
- **TestScoutToScannerContract** (5): scout_cache → watchlist → scanner 필드 보존 검증
- **TestGatewayContract** (4): KISGatewayClient 메서드 ↔ kis-gateway 라우트 매핑
- **TestExecutorGatewayContract** (3): executor.py의 self.kis.* 호출이 실제 존재하는지 정적 검증

#### Layer 2: Spec Mock Validation
- **TestSpecMockValidation** (4): create_autospec이 존재하지 않는 메서드/잘못된 인자를 잡는 것을 검증
- cancel_order 미구현 같은 버그가 MagicMock으로는 발견 불가능함을 문서화

#### Layer 3: Boundary/Negative Tests
- **TestMomentumBoundary** (5): `>=` 연산자 경계값 (cap=7.0%, threshold=3.0%, cont_cap=5.0%)
- **TestConvictionBoundary** (7): 확신도 OR 로직, 시간 윈도우 경계값 (09:15, 10:30)

## 테스트 결과

```
tests/shared/         → 1220 passed, 1 skipped (기존 1202 → +18)
tests/shared/broker/  → 40 passed (기존 36 → +4)
buy-scanner tests     → 38 passed (기존 23 → +15 new, 이전 미커밋 +12도 포함)
```

## 수정된 파일

| 파일 | 작업 |
|------|------|
| `tests/shared/test_contracts.py` | **신규** — 12개 계약 테스트 |
| `tests/shared/broker/test_kis_adapter.py` | 수정 — 4개 Spec Mock 테스트 추가 |
| `tests/services/buy-scanner/test_conviction_entry.py` | **신규** — 38개 (conviction+momentum+boundary) |
| `services/buy-scanner/opportunity_watcher.py` | 수정 — conviction entry, momentum cap, DIP_BUY 완화 |
| `services/scout-job/scout_cache.py` | 수정 — trade_tier/hybrid_score 전달 |
| `shared/watchlist.py` | 수정 — trade_tier/hybrid_score 저장 |
| `docker-compose.yml` | 수정 — conviction entry env vars |
| `infrastructure/env-vars-wsl.yaml` | 수정 — conviction/momentum 파라미터 |
| `scripts/analyze_trade_entry_timing.py` | **신규** — 전략별 성과 분석 |

## 향후 작업

- `conftest.py`에 `mock_kis_strict` 전역 fixture 추가 → E2E 테스트 점진적 마이그레이션
- 사문화 전략 로직 테스트 (이미 비활성화되어 우선순위 낮음)
