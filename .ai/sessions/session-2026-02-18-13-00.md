# Session 2026-02-18 13:00 — 연휴 후 시스템 점검 (E2E 테스트)

## 목적
설 연휴 후 내일(2/19) 장 시작 전 시스템 정상 동작 검증.

## 변경사항

### 1. E2E 테스트 수정 3건

#### a. Stale Score 영업일 계산 버그 (`tests/e2e/test_filter_chain.py`)
- **문제**: scored_dt 역산 알고리즘이 주말 교차 시 1일 초과 계산
  - 예: 오늘 수요일(2/18)에서 2영업일 역산 → Feb 13(목) 산출 → 실제 카운트 3영업일
- **원인**: "N영업일 뒤로 가서 1일 더 빼기" 로직이 주말 건너뛰기를 잘못 처리
- **수정**: 직접 scored_dt를 1일씩 후퇴하며 biz_days를 실제 카운트하여 목표값 일치 시 중단
- **영향**: `test_2_business_days_half_position`, `test_3_business_days_minimal_position`, `test_stale_score_reduces_but_allows`

#### b. Friday-to-Monday datetime 패치 실패 (`tests/e2e/test_filter_chain.py`)
- **문제**: `sys.modules.get('buy_executor_dynamic')`이 None 반환 → datetime 패치 미적용 → 실시간 날짜 사용
- **원인**: `buy_executor_class` fixture가 `spec.loader.exec_module(module)` 후 sys.modules에 미등록
- **수정**: 테스트 내에서 직접 모듈 로드 + datetime 패치 적용

#### c. Portfolio Guard 동적 예산 미격리 (`tests/e2e/test_incident_20260212.py`)
- **문제**: `_make_guard()` 헬퍼가 `DYNAMIC_SECTOR_BUDGET_ENABLED` 미설정 → 기본값 True → 실 Redis 연결 → 동적 cap=5 로드
- **수정**: `values` dict에 `"DYNAMIC_SECTOR_BUDGET_ENABLED": False` 명시

### 2. Pre-existing 변경 (이전 세션에서 unstaged)

#### a. vLLM 버전 고정 + HF_HUB_OFFLINE (`docker-compose.yml`)
- `vllm/vllm-openai:latest` → `vllm/vllm-openai:v0.15.1`
- `HF_HUB_OFFLINE=1` 환경변수 추가 (오프라인 모델 로드)

#### b. 마이그레이션 스크립트 개선 (`utilities/migrate_news_sentiment.py`)
- collation 충돌 해결 + NOT IN → LEFT JOIN 최적화

## 테스트 결과

| Suite | Passed | Failed | Time |
|-------|--------|--------|------|
| shared | 1219 | 1 (VIX mock, pre-existing) | 16s |
| services | 250 | 0 | 14m14s |
| E2E | 102 | 0 | 4.8s |
| **Total** | **1571** | **1** | ~15min |

## 프로덕션 서비스 상태
- Docker 29개 서비스: 전부 Up + Healthy
- Redis Streams 3개: pending=0, lag=0
- vLLM LLM/Embed: 정상 응답
- KIS Gateway: 6420건, 성공률 100%

## 파일 변경 목록
- `docker-compose.yml` — vLLM 버전 고정 + HF_HUB_OFFLINE
- `tests/e2e/test_filter_chain.py` — stale score 영업일 계산 + datetime 패치 수정
- `tests/e2e/test_incident_20260212.py` — Portfolio Guard 동적 예산 격리
- `utilities/migrate_news_sentiment.py` — collation + LEFT JOIN 최적화
