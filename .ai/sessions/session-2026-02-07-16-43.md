# Session Handoff: 네이버 업종 분류 기반 섹터 통합 + Unified Analyst Pipeline

## 요약 (Summary)
네이버 금융 업종 분류(79개 세분류)를 Single Source of Truth로 채택하여, 기존 3가지 분산된 섹터 분류(scout_universe SECTOR_MAPPING 하드코딩, DB SECTOR_KOSPI200, SectorClassifier 키워드 추론)를 통합함. 또한 3→1 LLM 호출 통합(Unified Analyst Pipeline)과 코드 기반 risk_tag 분류를 구현.

## 변경 사항 (Changes)

### 네이버 업종 통합
- `shared/crawlers/naver.py`: 업종 크롤링 함수 3개 추가 (get_naver_sector_list, get_naver_sector_stocks, build_naver_sector_mapping)
- `shared/crawlers/__init__.py`: 신규 함수 export 추가
- `shared/db/models.py`: StockMaster에 `sector_naver`, `sector_naver_group` 컬럼 추가
- `shared/sector_taxonomy.py`: **신규** - NAVER_TO_GROUP 매핑 (79개 세분류 → ~14개 대분류)
- `shared/sector_classifier.py`: v4.0 - SECTOR_NAVER 우선 조회 + get_sector_group() 메서드 추가
- `shared/db/factor_repository.py`: get_stock_sector_naver() 메서드 추가
- `shared/hybrid_scoring/factor_analyzer.py`: SECTOR_MAPPING 삭제 → DB 기반 조회
- `services/scout-job/scout_universe.py`: SECTOR_MAPPING (~150개) 삭제 → DB 기반 _resolve_sector()
- `services/scout-job/scout.py`: SECTOR_MAPPING import 제거, Council 섹터 매칭을 양방향 부분문자열 매칭으로 수정
- `utilities/update_naver_sectors.py`: **신규** - 네이버 업종 배치 업데이트 스크립트
- `tests/shared/test_naver.py`: 업종 크롤러 9개 테스트 추가
- `tests/shared/test_sector_classifier.py`: DB 쿼리 패턴 mock 업데이트
- `tests/shared/hybrid_scoring/test_factor_analyzer.py`: DB 기반 조회 반영

### Unified Analyst Pipeline (3→1 LLM 호출 통합)
- `shared/hybrid_scoring/quant_scorer.py`: classify_risk_tag() 코드 기반 risk_tag 분류 추가
- `shared/llm_prompts.py`: ANALYST_RESPONSE_SCHEMA, build_unified_analyst_prompt() 추가
- `shared/llm_constants.py`: ANALYST_RESPONSE_SCHEMA 정의, 가드레일 ±15pt
- `shared/llm.py`: run_analyst_scoring() 추가 (1회 LLM 호출로 통합)
- `services/scout-job/scout_pipeline.py`: SCOUT_USE_UNIFIED_ANALYST=true 토글, 코드 기반 risk_tag
- `services/scout-job/scout.py`: unified analyst 환경변수 설정
- `docker-compose.yml`: SCOUT_USE_UNIFIED_ANALYST=true 환경변수 추가
- `tests/shared/test_llm_brain.py`: unified analyst 테스트 추가
- `tests/shared/test_llm_prompts.py`: unified analyst 프롬프트 테스트 추가
- `tests/shared/hybrid_scoring/test_quant_scorer.py`: risk_tag 테스트 추가
- `tests/services/scout-job/test_scout_pipeline.py`: **신규** - scout pipeline 18개 테스트

## 핵심 발견 (Key Findings)
- Council 회피/선호 섹터 매칭에서 exact match 버그 발견 및 수정 (e.g., Council "반도체" vs Naver "반도체와반도체장비")
- DB에 995개 종목 SECTOR_NAVER 데이터 투입 완료 (3093개는 STOCK_MASTER 미등록 → 정상)
- LLM risk_tag 100% CAUTION 편향 문제를 코드 기반 classify_risk_tag()로 해결

## 다음 단계 (Next Steps)
- [ ] `python utilities/update_naver_sectors.py` 주기적 실행 설정 (Airflow DAG 또는 주 1회 수동)
- [ ] QUALITY_VALUE 가중치 전환 검증 (rolling window 백테스트 필요)
- [ ] Unified Analyst Pipeline 프로덕션 모니터링 (SCOUT_USE_UNIFIED_ANALYST=true 상태)
- [ ] 섹터 모멘텀 분석에 네이버 업종 기반 데이터 확인

## Context for Next Session
- `shared/sector_taxonomy.py`: 네이버 세분류→대분류 매핑 (Single Source of Truth)
- `shared/sector_classifier.py`: v4.0 SECTOR_NAVER 우선 조회
- `services/scout-job/scout_pipeline.py`: unified analyst + 코드 기반 risk_tag
- `shared/llm_constants.py`: ANALYST_RESPONSE_SCHEMA, 가드레일 설정
- `docs/backtest-analysis-2026-02-07.md`: Factor Alpha 백테스트 결과
