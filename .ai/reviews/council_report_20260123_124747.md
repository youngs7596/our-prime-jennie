# Prime Council Report
- Date: 2026-01-23 12:49:30
- Query: 현재 매도 전략 최적화 문의입니다.

## 현황
- 매수 후 Scale-out(분할 익절) + RSI Overbought + Trailing Stop + Profit Floor 등 여러 전략이 동시 작동
- 최근 대우건설 사례: 900주 매수 후 6번에 걸쳐 분할 매도, 마지막 28주(14.6만원)는 수익 7천원(수수료와 비슷)
- 분할이 너무 잦아 소량 거래로 수수료 비효율 발생

## 현재 Scale-out 설정
- L1: +5% 도달 시 25% 매도
- L2: +10% 도달 시 25% 매도  
- L3: +15% 도달 시 25% 매도
- 나머지 25%: Trailing Stop 또는 RSI로 청산

## 질문
1. 수익률을 극대화하려면 분할 매도 비율을 어떻게 조정해야 할까요?
2. 최소 거래금액(예: 50만원) 가드를 도입해야 할까요?
3. 상승장에서 더 공격적으로 수익을 끌어가는 전략은?
4. Scale-out 횟수 제한 vs 잔여수량 기준 전량매도 중 어떤 게 나을까요?
- Target: None

# Final Plan: 매도 전략 최적화

## 1) 승인된 범위 (Approved scope)
- 소량 거래 수수료 비효율 제거
- Scale-out 로직 단순화
- 시장 국면별 적응형 매도 트리거
- 실거래 영향 있음 → 단계적 롤아웃 필수

## 2) 실행 순서가 있는 액션 스텝 (Action Steps)
1. **최소 거래금액 가드 도입**: 매도 주문 시, `거래금액 < 50만원` 또는 `잔여수량 < 50주`인 경우 해당 매도 주문을 실행하지 않도록 로직 수정.
2. **강제 청산 로직 추가**: Scale-out 완료 또는 최종 트리거 발화 시, 최소 거래금액 미달 잔여수량을 강제 청산하는 로직 추가.
3. **Scale-out 횟수 제한**: 매도 트리거 중복 방지 및 로직 단순화를 위해 Scale-out 횟수를 최대 3회로 제한.
4. **트리거 우선순위 명확화**: 각 매도 트리거의 우선순위를 명확히 하여 중복 발화를 방지.
5. **A/B 테스트 설계**: 새로운 매도 전략의 효과를 검증하기 위한 A/B 테스트 설계 및 실행.
6. **관측 데이터 수집**: 매도 트리거 발화 순서, 당시 RSI/Trailing Stop 상태, 시장 국면 분류 데이터 수집.
7. **리스크 모니터링**: 새로운 전략 적용 후, 수익률 및 최대 낙폭을 지속적으로 모니터링하여 롤백 트리거 조건 충족 여부 확인.

## 3) 실험 및 수용 기준 (Experiments & Acceptance criteria)
- **실험 1**: Scale-out 비율 및 레벨 조정에 따른 수익률 변화 분석
  - 성공 기준: `net_profit_per_trade` 10% 이상 증가
- **실험 2**: Trailing Stop과 RSI Overbought의 동시 작동 효과 분석
  - 성공 기준: `max_profit_achieved_before_exit` 증가 및 `number_of_premature_exits` 감소

## 4) 리스크 및 롤백 트리거 (Risk & rollback triggers)
- **리스크**:
  - 최소 거래금액 가드 도입 후 포지션 좀비화 발생 가능성
  - Scale-out 횟수 제한으로 인한 수익 감소 가능성
  - 시장 국면 지표 오류로 인한 잘못된 매도 결정
  - Trailing Stop 폭 확대 시 손실 확대 가능성

- **롤백 트리거**:
  - 포지션 좀비화: 월 3회 이상 "포지션의 5% 이상이 5거래일 이상 미청산" 사례 발생 시
  - 수익률 악화: 새 전략 적용 후 30일 누적 `net_profit_per_trade`가 기존 대비 10% 이상 감소 시
  - 최대 낙폭 증가: `max_drawdown`이 기존 대비 5% 이상 증가 시
  - 강제 청산 오류: `force_exit_small_lot` 실행 중 주문 실패율이 5% 이상 발생 시

## Notes
- 제니와 민지의 의견을 반영하여, 리스크 관리 및 실험 설계에 대한 세부 사항을 보완하였습니다.

---
## Appendix: Raw JSON Outputs
<details><summary>Click to expand</summary>

### Jennie
```json
{
  "text": "## Verdict\n- decision: approve_with_changes\n- confidence: 90\n- scope: 현재 매도 전략의 비효율성(소량 거래 수수료 문제)을 해결하고, 상승장에서의 수익 극대화를 위한 Scale-out 비율 및 매도 트리거 로직 최적화.\n\n## Key Findings (<=5)\n1.  **거래 비용 비효율성**: 대우건설 사례에서 보듯이, 소량의 잔여 물량을 여러 번에 걸쳐 매도하는 현재의 Scale-out 전략은 거래 수수료로 인해 실질 수익이 크게 감소하거나 심지어 손실로 이어질 수 있습니다.\n2.  **고정된 Scale-out 비율의 한계**: 현재 +5%, +10%, +15%의 고정된 Scale-out 비율은 시장의 상승 모멘텀이 강할 때 조기 익절로 이어져 잠재적 추가 수익을 놓칠 가능성이 높습니다.\n3.  **시장 국면 미고려**: 현재 매도 전략은 시장 국면(예: 강세장, 횡보장)에 따라 유연하게 조정되지 않아, 강세장에서 공격적인 수익 추구가 어렵고, 횡보장에서는 불필요한 매매를 유발할 수 있습니다.\n4.  **복합 트리거의 상호작용 불분명**: Scale-out, RSI Overbought, Trailing Stop, Profit Floor 등 여러 매도 전략이 동시에 작동하면서, 각 전략의 상호작용이 명확하지 않아 최적의 매도 시점을 놓치거나 과도하게 보수적인 매도를 유발할 수 있습니다.\n\n## Evidence\n- references:\n    - log_snippet: \"대우건설 사례: 900주 매수 후 6번에 걸쳐 분할 매도, 마지막 28주(14.6만원)는 수익 7천원(수수료와 비슷)\"\n    - config_setting: \"Scale-out L1: +5% 도달 시 25% 매도, L2: +10% 도달 시 25% 매도, L3: +15% 도달 시 25% 매도, 나머지 25%: Trailing Stop 또는 RSI로 청산\"\n    - metric_observation: \"분할이 너무 잦아 소량 거래로 수수료 비효율 발생\"\n- missing_data:\n    - `transaction_cost_structure`: 정확한 수수료(거래세, 증권사 수수료 등) 구조 및 각 거래 건별 실제 수수료 지불 내역이 있다면, 최소 거래 금액 가드의 임계값을 더 정밀하게 설정하고, 현재 전략의 비효율성을 수치화하는 데 도움이 될 것입니다.\n    - `historical_trade_data_with_market_regime`: 과거 매도 거래별 시장 국면(예: 강세장, 약세장, 횡보장, 고변동성, 저변동성) 분류 데이터가 있다면, 특정 국면에서 매도 전략이 어떻게 작동했는지 분석하여 국면별 최적화 방안을 도출할 수 있습니다.\n    - `full_trade_log_for_Daewoo_E&C`: 대우건설 거래의 전체 매수/매도 시점, 가격, 수량, 당시 시장 상황(RSI, Trailing Stop 상태 등)에 대한 상세 로그가 있다면, 각 매도 결정이 어떤 트리거에 의해 발생했는지 정확히 파악하고, 놓친 기회 비용을 더 명확히 계산할 수 있습니다.\n\n## Risks & Veto Triggers\n- risks:\n    - **과도한 최적화(Over-optimization)**: 특정 과거 데이터에만 맞춰 매도 전략을 조정할 경우, 미래 시장 환경 변화에 취약해질 수 있습니다.\n    - **유동성 문제**: 최소 거래 금액 가드를 너무 높게 설정할 경우, 소형주나 유동성이 낮은 종목에서 잔여 물량 청산이 어려워질 수 있습니다.\n    - **수익률 감소**: 공격적인 매도 전략(예: Trailing Stop 완화)은 단기적으로 더 큰 수익을 가져올 수 있지만, 시장 반전 시 손실 폭을 키울 수 있습니다.\n- veto_if:\n    - 최소 거래 금액 가드 도입 후, 해당 가드 때문에 포지션의 10% 이상이 5거래일 이상 청산되지 못하고 잔류하는 사례가 월 3회 이상 발생할 경우.\n    - 새로운 매도 전략 적용 후, 전체 거래의 평균 `net_profit_per_trade`가 기존 대비 10% 이상 감소하거나, `max_drawdown`이 5% 이상 증가할 경우.\n\n## Recommendations\n\n- immediate_actions:\n    1.  **최소 거래 금액/수량 가드 도입**: 매도 주문 시, `거래금액 < 50만원` 또는 `잔여수량 < 50주` (둘 중 하나라도 해당 시)인 경우 해당 매도 주문을 실행하지 않고, 다음 매도 트리거 발생 시 잔여 물량을 합쳐서 매도하도록 로직을 수정합니다. (정확한 임계값은 백테스트를 통해 최적화 필요)\n    2.  **잔여 물량 통합 매도 로직 구현**: 모든 Scale-out 레벨이 완료된 후, 또는 Trailing Stop/RSI Overbought 트리거 발생 시 잔여 물량이 최소 거래 금액/수량 가드에 미달하는 경우, 해당 잔여 물량을 즉시 전량 매도하는 `force_exit_small_lot` 로직을 추가합니다. (단, `Profit Floor`는 여전히 준수)\n    3.  **Scale-out 횟수 제한**: 한 종목당 Scale-out 매도 횟수를 최대 3회로 제한하고, 이후 잔여 물량은 Trailing Stop 또는 RSI Overbought 트리거에 따라 전량 매도하도록 변경합니다.\n\n- experiments:\n    1.  **Hypothesis**: 현재의 고정된 Scale-out 비율 및 레벨은 시장 국면에 따라 최적의 수익률을 달성하지 못하며, 특히 강세장에서 조기 익절로 인한 기회 손실이 크다.\n        *   **Method**:\n            *   **A/B Test 1 (Scale-out Profile)**:\n                *   **Group A (Current)**: L1: +5% (25%), L2: +10% (25%), L3: +15% (25%), Rem: 25%\n                *   **Group B (Less Aggressive Early)**: L1: +7% (15%), L2: +12% (25%), L3: +20% (30%), Rem: 30%\n                *   **Group C (Fewer Levels)**: L1: +10% (30%), L2: +20% (30%), Rem: 40%\n            *   **A/B Test 2 (Dynamic Scale-out)**:\n                *   **Group D (Market Regime Adaptive)**: `market_regime_indicator` (예: 200일 이동평균선 상방, VIX 지수 하락 등)가 강세장으로 분류될 경우, Scale-out 레벨을 50% 상향 조정 (예: L1: +7.5%, L2: +15%, L3: +22.5%)하거나, Trailing Stop의 폭을 1.5배 확대.\n        *   **Success Metrics**:\n            *   `net_profit_per_trade` (평균 순수익)\n            *   `profit_factor` (총 수익 / 총 손실)\n            *   `average_holding_period` (평균 보유 기간)\n            *   `upside_capture_ratio` (매도 후 추가 상승분 대비 실제 수익률)\n            *   `transaction_cost_ratio` (총 거래 비용 / 총 거래 금액)\n\n    2.  **Hypothesis**: Trailing Stop과 RSI Overbought의 동시 작동은 때때로 중복되거나 과도하게 보수적으로 작용하여 수익 극대화를 저해할 수 있다.\n        *   **Method**:\n            *   **A/B Test**:\n                *   **Group E (Current)**: Trailing Stop + RSI Overbought 동시 작동\n                *   **Group F (Trailing Stop Only)**: RSI Overbought 트리거 비활성화\n                *   **Group G (RSI Overbought Only)**: Trailing Stop 트리거 비활성화\n        *   **Success Metrics**:\n            *   `net_profit_per_trade`\n            *   `max_profit_achieved_before_exit` (매도 시점까지 도달한 최고 수익률)\n            *   `exit_efficiency_score` (최고점 대비 매도 가격 비율)\n            *   `number_of_premature_exits` (매도 후 5% 이상 추가 상승한 경우)\n\n- if_code_change_needed:\n    *   `sell_strategy_module.py`: `_execute_scale_out_sell()` 함수 내에 `min_transaction_value_guard`, `min_shares_guard`, `scale_out_count_limit` 로직 추가.\n    *   `sell_strategy_module.py`: `_check_exit_conditions()` 함수에 `force_exit_small_lot` 로직 추가 및 `market_regime_adaptive_parameters` 로직을 위한 조건부 매개변수 로딩 구현.\n    *   `config.py`: `SCALE_OUT_LEVELS`, `MIN_TRANSACTION_VALUE`, `MIN_SHARES_FOR_SALE`, `MAX_SCALE_OUT_COUNT`, `MARKET_REGIME_ADJUSTMENT_FACTOR` 등의 설정값 추가.\n\n## Questions to the User\n- 현재 시스템에서 시장 국면(예: 강세장, 약세장, 횡보장)을 분류하는 지표나 로직이 이미 존재하나요? 존재한다면 어떤 지표를 사용하고 있습니까?\n- `Profit Floor` 설정값은 현재 얼마이며, 이로 인해 매도가 지연되거나 취소된 사례가 얼마나 자주 발생했는지에 대한 데이터가 있습니까?\n- 대우건설 사례와 유사하게, 소량 매도로 인해 수수료 비효율이 발생한 다른 종목들의 구체적인 사례(매수/매도 가격, 수량, 수익률, 수수료)를 추가로 제공해 주실 수 있나요? 이는 문제의 보편성을 판단하는 데 중요합니다.",
  "decision": "neutral",
  "raw_output": true
}
```
### Minji
```json
{
  "text": "# Council Output: 매도 전략 최적화 검토\n\n## Verdict\n- **decision**: approve_with_changes\n- **confidence**: 85\n- **scope**: 소량 거래 수수료 비효율 제거 + Scale-out 로직 단순화 + 시장 국면별 적응형 매도 트리거. **실거래 영향 있음** → 단계적 롤아웃 필수.\n\n---\n\n## Key Findings (<=5)\n\n1. **수수료 비효율이 실제 문제**: 대우건설 28주(14.6만원) 사례는 증권사 수수료(0.015~0.025%) + 거래세(0.1%)로 인해 순수익이 거의 0에 수렴하는 전형적인 사례. 이는 **시스템 버그가 아니라 설정 결함**입니다.\n\n2. **Scale-out 레벨 과다**: 6번 매도는 현재 설정(L1, L2, L3 + Trailing Stop/RSI)에서 여러 트리거가 동시 발화하거나 순차 발화한 결과. 각 트리거 간 **우선순위/상호배제 로직이 불명확**합니다.\n\n3. **고정 비율의 한계**: +5%, +10%, +15%는 시장 변동성, 추세 강도, 거래량을 무시한 설정. 강세장에서는 조기 익절, 약세장에서는 과도한 보유로 이어집니다.\n\n4. **Profit Floor의 숨은 역할**: 현재 설정에서 Profit Floor가 얼마인지 불명확하면, 최소 거래금액 가드 도입 시 **상충(conflict)이 발생**할 수 있습니다.\n\n5. **관측 데이터 부족**: 현재 로그에 \"매도 트리거 발화 순서\", \"당시 RSI/Trailing Stop 상태\", \"시장 국면 분류\"가 없어서 근본 원인 분석이 제한적입니다.\n\n---\n\n## Evidence\n\n### References\n- **Log Snippet**: 대우건설 900주 → 6회 분할 매도 (25% + 25% + 25% + 25% 이후 추가 분할?)\n- **Config Setting**: \n  ```\n  L1: +5% → 25% 매도\n  L2: +10% → 25% 매도\n  L3: +15% → 25% 매도\n  Rem: 25% → Trailing Stop OR RSI Overbought\n  ```\n- **Metric Observation**: 마지막 28주 거래 = 약 14.6만원 × 0.1% 거래세 + 0.02% 수수료 ≈ 3,000~5,000원 비용 → 순수익 7,000원은 **거의 수수료 수준**\n\n### Missing Data (결론 변경 가능성 높음)\n| 항목 | 현황 | 필요성 |\n|------|------|--------|\n| **정확한 수수료 구조** | 미제시 | 🔴 높음 - 최소 거래금액 임계값 결정에 필수 |\n| **Profit Floor 설정값** | 미제시 | 🔴 높음 - 최소 거래금액 가드와 충돌 가능 |\n| **매도 트리거 로그** | 없음 | 🟠 중간 - 각 매도가 어느 트리거인지 파악 필요 |\n| **시장 국면 분류 데이터** | 없음 | 🟠 중간 - 강세/약세장 구분 후 전략 차등화 가능 |\n| **과거 6개월 거래 통계** | 없음 | 🟠 중간 - A/B 테스트 베이스라인 설정 필요 |\n\n---\n\n## Risks & Veto Triggers\n\n### Risks\n| 위험 | 심각도 | 완화 방안 |\n|------|--------|----------|\n| **최소 거래금액 가드 도입 후 포지션 좀비화** | 🔴 높음 | 강제 청산 로직(`force_exit_small_lot`)을 반드시 함께 구현; 월 1회 이상 발생 시 임계값 재조정 |\n| **Scale-out 횟수 제한으로 인한 수익 감소** | 🟠 중간 | A/B 테스트로 최적 횟수 결정; 현재 3회 제안은 가설일 뿐 |\n| **시장 국면 지표 오류** | 🟠 중간 | 200일 이동평균선 + VIX 같은 **이중 확인 지표** 사용; 단일 지표 의존 금지 |\n| **Trailing Stop 폭 확대 시 손실 확대** | 🟡 낮음 | 강세장 판정 후에만 적용; 약세장 전환 시 즉시 복구 |\n\n### Veto Triggers (이 중 하나라도 발생 시 롤백)\n1. **포지션 좀비화**: 최소 거래금액 가드 도입 후, 월 3회 이상 \"포지션의 5% 이상이 5거래일 이상 미청산\" 사례 발생\n2. **수익률 악화**: 새 전략 적용 후 30일 누적 `net_profit_per_trade`가 기존 대비 **10% 이상 감소**\n3. **최대 낙폭 증가**: `max_drawdown`이 기존 대비 **5% 이상 증가**\n4. **강제 청산 오류**: `force_exit_small_lot` 실행 중 주문 실패율이 **5% 이상**\n\n---\n\n## Recommendations\n\n### Immediate Actions (우선순위 순)\n\n#### 1️⃣ **최소 거래금액 가드 도입** (1주일 내)\n**목표**: 수수료 비효율 제거\n\n**구현 범위**:\n- 파일: `sell_strategy_module.py` (또는 해당 매도 로직 파일)\n- 함수: `_execute_scale_out_sell()` 또는 `_check_sell_conditions()`\n- 변경 내용:\n\n```python\n# 의사코드 (실제 구현은 기존 코드 구조에 맞춰 조정)\n\nMIN_TRANSACTION_VALUE = 500_000  # 50만원 (임계값은 백테스트로 최적화)\nMIN_SHARES_FOR_SALE = 50         # 50주 (종목별로 조정 필요)\n\ndef should_execute_sell(sell_quantity, current_price, symbol):\n    \"\"\"\n    매도 주문 실행 전 최소 거래금액 검증\n    \"\"\"\n    transaction_value = sell_quantity * current_price\n    \n    # 조건: 거래금액 AND 수량 모두 충족해야 실행\n    if transaction_value < MIN_TRANSACTION_VALUE or sell_quantity < MIN_SHARES_FOR_SALE:\n        logger.info(\n            f\"[{symbol}] 소량 매도 스킵: {sell_quantity}주 × {current_price}원 = {transaction_value}원 < {MIN_TRANSACTION_VALUE}원\",\n            extra={\"action\": \"skip_small_lot\", \"symbol\": symbol, \"qty\": sell_quantity}\n        )\n        return False\n    \n    return True\n```\n\n**Before/After**:\n- **Before**: 28주 × 14.6만원 = 408,800원 → 매도 실행 → 수수료 3,000~5,000원 손실\n- **After**: 408,800원 < 500,000원 → 매도 스킵 → 다음 트리거 시 잔여수량 합산\n\n**테스트**:\n- **Unit Test**: \n  ```python\n  assert should_execute_sell(28, 146000, \"DAEWOO\") == False\n  assert should_execute_sell(50, 146000, \"DAEWOO\") == True\n  ```\n- **Integration Test**: 과거 6개월 거래 데이터 재시뮬레이션 → 스킵된 매도 건수 및 최종 수익률 비교\n\n**롤백 계획**:\n- `MIN_TRANSACTION_VALUE` 설정값을 0으로 복구 → 기존 동작 복원\n\n**관측/검증**:\n- 로그: `[skip_small_lot]` 이벤트 발생 빈도 (목표: 월 1~2회)\n- 메트릭: `small_lot_skipped_count`, `avg_transaction_value_per_sell`\n- 성공 신호: 수수료 비효율로 인한 손실 거래 제거 → `net_profit_per_trade` 상승\n\n---\n\n#### 2️⃣ **강제 청산 로직 추가** (1주일 내)\n**목표**: 최소 거래금액 가드로 인한 포지션 좀비화 방지\n\n**구현 범위**:\n- 파일: `sell_strategy_module.py`\n- 함수: `_check_exit_conditions()` 또는 새 함수 `_force_exit_small_lot()`\n- 변경 내용:\n\n```python\ndef _force_exit_small_lot(position, current_price, symbol):\n    \"\"\"\n    Scale-out 완료 또는 최종 트리거 발화 시, \n    최소 거래금액 미달 잔여수량을 강제 청산\n    \"\"\"\n    remaining_qty = position.current_quantity\n    remaining_value = remaining_qty * current_price\n    \n    # 조건: \n    # 1) Scale-out 3회 완료 후 잔여수량이 있거나\n    # 2) Trailing Stop / RSI Overbought 트리거 발화 시 잔여수량이 있으면\n    # 3) Profit Floor는 여전히 준수하되, 강제 청산\n    \n    if remaining_qty > 0 and remaining_value < MIN_TRANSACTION_VALUE:\n        if position.current_profit >= position.profit_floor:  # Profit Floor 확인\n            logger.info(\n                f\"[{symbol}] 강제 청산: {remaining_qty}주 × {current_price}원 (Profit Floor 충족)\",\n                extra={\"action\": \"force_exit\", \"symbol\": symbol, \"qty\": remaining_qty}\n            )\n            return execute_sell_order(symbol, remaining_qty, \"MARKET\")\n        else:\n            logger.warning(\n                f\"[{symbol}] 강제 청산 보류: Profit Floor 미충족 ({position.current_profit}% < {position.profit_floor}%)\",\n                extra={\"action\": \"force_exit_blocked\", \"symbol\": symbol}\n            )\n            return None\n```\n\n**Before/After**:\n- **Before**: 28주 잔여 → 다음 매도 트리거 대기 (며칠 소요 가능)\n- **After**: Scale-out 3회 완료 후 즉시 강제 청산 (Profit Floor 충족 시)\n\n**테스트**:\n- **Unit Test**: \n  ```python\n  position = Position(qty=28, profit=8%, profit_floor=5%)\n  assert _force_exit_small_lot(position, 146000, \"DAEWOO\") is not None\n  ```\n- **Integration Test**: 과거 거래에서 \"잔여수량 > 0\"인 경우 강제 청산 시뮬레이션\n\n**롤백 계획**:\n- `_force_exit_small_lot()` 함수 호출 제거 → 기존 Trailing Stop/RSI 로직만 작동\n\n**관측/검증**:\n- 로그: `[force_exit]` 이벤트 발생 빈도 및 성공률\n- 메트릭: `forced_exit_count`, `forced_exit_success_rate`, `avg_holding_period_after_force_exit`\n- 성공 신호: 포지션 좀비화 사례 0 → 평균 보유 기간 단축\n\n---\n\n#### 3️⃣ **Scale-out 횟수 제한 + 트리거 우선순위 명확화** (2주일 내)\n**목표**: 매도 트리거 중복 방지 + 로직 단순화\n\n**구현 범위**:\n- 파일: `sell_strategy_module.py`\n- 함수: `_execute_scale_out_sell()`, `_check_exit_conditions()`\n- 변경 내용:\n\n```python\nMAX_SCALE_OUT_COUNT = 3  # 현재 L1, L2, L3 → 최대 3회로 제한\n\nclass SellTriggerPriority:\n    \"\"\"매도 트리거 우선순위 (높을수록 먼저 실행)\"\"\"\n    PROFIT_FLOOR_BREACH = 100      # 손절 (최우선)\n    SCALE_OUT_LEVEL = 50           # Scale-out L1, L2, L3\n    TRAILING_STOP = 40             # Trailing Stop\n    RSI_OVERBOUGHT = 30            # RSI > 70 (최하위)\n\ndef _execute_sell_logic(position, market_data, symbol):\n    \"\"\"\n    트리거 우선순위에 따라 매도 실행\n    \"\"\"\n    # 1) Profit Floor 확인 (손절)\n    if position.current_profit < position.profit_floor:\n        logger.info(f\"[{symbol}] 손절 실행: {position.current_profit}% < {position.profit_floor}%\")\n        return execute_sell_order(symbol, position.current_quantity, \"MARKET\")\n    \n    # 2) Scale-out 레벨 확인 (최대 3회)\n    if position.scale_out_count < MAX_SCALE_OUT_COUNT:\n        scale_out_level = _check_scale_out_level(position.current_profit)\n        if scale_out_level is not None:\n            sell_qty = position.current_quantity * 0.25  # 25% 매도\n            if should_execute_sell(sell_qty, market_data.current_price, symbol):\n                logger.info(f\"[{symbol}] Scale-out L{scale_out_level}: {sell_qty}주 매도\")\n                execute_sell_order(symbol, sell_",
  "error": "JSON Parse Failed: Expecting property name enclosed in double quotes: line 1 column 2 (char 1)",
  "raw_json_snippet": "{symbol}] 소량 매도 스킵: {sell_quantity}주 × {current_price}원 = {transaction_value}원 < {MIN_TRANSACTION_VALUE}원\",\n            extra={\"action\": \"skip_small_lot\", \"symbol\": symbol, \"qty\": sell_quantity}\n     "
}
```
### Junho
```json
{
  "text": "## Verdict\n- decision: approve_with_changes\n- confidence: 85\n- scope: 소량 거래 수수료 비효율 제거 + Scale-out 로직 단순화 + 시장 국면별 적응형 매도 트리거. **실거래 영향 있음** → 단계적 롤아웃 필수.\n\n## Key Findings (<=5)\n1. **수수료 비효율이 실제 문제**: 대우건설 28주(14.6만원) 사례는 증권사 수수료(0.015~0.025%) + 거래세(0.1%)로 인해 순수익이 거의 0에 수렴하는 전형적인 사례. 이는 **시스템 버그가 아니라 설정 결함**입니다.\n2. **Scale-out 레벨 과다**: 6번 매도는 현재 설정(L1, L2, L3 + Trailing Stop/RSI)에서 여러 트리거가 동시 발화하거나 순차 발화한 결과. 각 트리거 간 **우선순위/상호배제 로직이 불명확**합니다.\n3. **고정 비율의 한계**: +5%, +10%, +15%는 시장 변동성, 추세 강도, 거래량을 무시한 설정. 강세장에서는 조기 익절, 약세장에서는 과도한 보유로 이어집니다.\n4. **Profit Floor의 숨은 역할**: 현재 설정에서 Profit Floor가 얼마인지 불명확하면, 최소 거래금액 가드 도입 시 **상충(conflict)이 발생**할 수 있습니다.\n5. **관측 데이터 부족**: 현재 로그에 \"매도 트리거 발화 순서\", \"당시 RSI/Trailing Stop 상태\", \"시장 국면 분류\"가 없어서 근본 원인 분석이 제한적입니다.\n\n## Evidence\n- references:\n    - log_snippet: \"대우건설 900주 → 6회 분할 매도 (25% + 25% + 25% + 25% 이후 추가 분할?)\"\n    - config_setting: \"L1: +5% → 25% 매도, L2: +10% → 25% 매도, L3: +15% → 25% 매도, Rem: 25% → Trailing Stop OR RSI Overbought\"\n    - metric_observation: \"마지막 28주 거래 = 약 14.6만원 × 0.1% 거래세 + 0.02% 수수료 ≈ 3,000~5,000원 비용 → 순수익 7,000원은 거의 수수료 수준\"\n- missing_data:\n    - 정확한 수수료 구조: 최소 거래금액 임계값 결정에 필수\n    - Profit Floor 설정값: 최소 거래금액 가드와 충돌 가능\n    - 매도 트리거 로그: 각 매도가 어느 트리거인지 파악 필요\n    - 시장 국면 분류 데이터: 강세/약세장 구분 후 전략 차등화 가능\n    - 과거 6개월 거래 통계: A/B 테스트 베이스라인 설정 필요\n\n## Risks & Veto Triggers\n- risks:\n    - **최소 거래금액 가드 도입 후 포지션 좀비화**: 강제 청산 로직(`force_exit_small_lot`)을 반드시 함께 구현; 월 1회 이상 발생 시 임계값 재조정\n    - **Scale-out 횟수 제한으로 인한 수익 감소**: A/B 테스트로 최적 횟수 결정; 현재 3회 제안은 가설일 뿐\n    - **시장 국면 지표 오류**: 200일 이동평균선 + VIX 같은 **이중 확인 지표** 사용; 단일 지표 의존 금지\n    - **Trailing Stop 폭 확대 시 손실 확대**: 강세장 판정 후에만 적용; 약세장 전환 시 즉시 복구\n- veto_if:\n    - 포지션 좀비화: 최소 거래금액 가드 도입 후, 월 3회 이상 \"포지션의 5% 이상이 5거래일 이상 미청산\" 사례 발생\n    - 수익률 악화: 새 전략 적용 후 30일 누적 `net_profit_per_trade`가 기존 대비 **10% 이상 감소**\n    - 최대 낙폭 증가: `max_drawdown`이 기존 대비 **5% 이상 증가**\n    - 강제 청산 오류: `force_exit_small_lot` 실행 중 주문 실패율이 **5% 이상**\n\n## Recommendations\n- immediate_actions:\n    1. **최소 거래금액 가드 도입**: 매도 주문 시, `거래금액 < 50만원` 또는 `잔여수량 < 50주` (둘 중 하나라도 해당 시)인 경우 해당 매도 주문을 실행하지 않고, 다음 매도 트리거 발생 시 잔여 물량을 합쳐서 매도하도록 로직을 수정합니다.\n    2. **강제 청산 로직 추가**: Scale-out 완료 또는 최종 트리거 발화 시, 최소 거래금액 미달 잔여수량을 강제 청산하는 로직을 추가합니다.\n    3. **Scale-out 횟수 제한 + 트리거 우선순위 명확화**: 매도 트리거 중복 방지 및 로직 단순화를 위해 Scale-out 횟수를 최대 3회로 제한하고, 각 트리거의 우선순위를 명확히 합니다.\n\n## Questions to the User\n- 현재 시스템에서 시장 국면(예: 강세장, 약세장, 횡보장)을 분류하는 지표나 로직이 이미 존재하나요? 존재한다면 어떤 지표를 사용하고 있습니까?\n- `Profit Floor` 설정값은 현재 얼마이며, 이로 인해 매도가 지연되거나 취소된 사례가 얼마나 자주 발생했는지에 대한 데이터가 있습니까?\n- 대우건설 사례와 유사하게, 소량 매도로 인해 수수료 비효율이 발생한 다른 종목들의 구체적인 사례(매수/매도 가격, 수량, 수익률, 수수료)를 추가로 제공해 주실 수 있나요? 이는 문제의 보편성을 판단하는 데 중요합니다.",
  "decision": "neutral",
  "raw_output": true
}
```

</details>

---
## Cost Summary
| Model | Input | Output | Cost (USD) |
|-------|-------|--------|------------|
| Jennie (Gemini) | 0 | 0 | $0.0000 |
| Minji (Claude) | 2,425 | 2,388 | $0.2155 |
| Junho (OpenAI) | 0 | 0 | $0.0000 |
| Orchestrator (OpenAI) | 5,483 | 491 | $0.0011 |
| **Total** | - | - | **$0.2166** (≈314원) |
